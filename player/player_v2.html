<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />
    <title>Netease Music Player</title>
    <style>
        :root {
            --active-color: #ffffff;
            --inactive-color: rgba(255, 255, 255, 0.45); 
            --blur-intensity: 60px;
            --gradient-feather: 20px; 
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #000;
            user-select: none; /* é˜²æ­¢åŒå‡»é€‰ä¸­æ–‡æœ¬ */
        }

        #bg-layer {
            position: fixed;
            top: -100px; left: -100px; right: -100px; bottom: -100px;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            filter: blur(var(--blur-intensity)) brightness(0.5);
            z-index: 1;
            transition: background-image 0.8s ease-in-out;
        }

        .container {
            position: relative;
            z-index: 2;
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }

        /* === å·¦ä¾§ä¿¡æ¯åŒº (å¸ƒå±€è°ƒæ•´) === */
        .info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 450px;
            /* ç¨å¾®ç•™å‡ºä¸€ç‚¹ä¸‹è¾¹è·ç»™æ–°æ§ä»¶ */
            padding-bottom: 20px; 
        }

        .album-art {
            width: 320px; /* ç¨å¾®è°ƒå°ä¸€ç‚¹ç»™ä¸‹æ–¹è…¾ç©ºé—´ */
            height: 320px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            object-fit: cover;
            margin-bottom: 25px;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            background-color: rgba(255,255,255,0.1);
        }
        
        .album-art.playing {
            transform: scale(1.02);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        .text-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .song-title {
            font-size: 28px;
            font-weight: 800;
            margin: 0 0 8px 0;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            line-height: 1.2;
            /* è¶…è¿‡ä¸¤è¡Œçœç•¥ */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .artist-name {
            font-size: 18px;
            color: rgba(255,255,255,0.8);
            margin: 0;
            font-weight: 500;
        }

        /* === æ–°å¢ï¼šè¿›åº¦æ¡åŒºåŸŸ === */
        .progress-container {
            width: 80%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .time-label {
            font-size: 12px;
            font-variant-numeric: tabular-nums; /* ç­‰å®½æ•°å­—é˜²æ­¢è·³åŠ¨ */
            color: rgba(255,255,255,0.6);
            min-width: 35px;
        }

        .progress-bar-bg {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: #fff;
            width: 0%;
            border-radius: 2px;
            /* ç§»é™¤ transitionï¼Œåœ¨ JS ä¸­ç”¨ requestAnimationFrame åšæ›´å¹³æ»‘çš„åŠ¨ç”» */
        }

        /* === æ–°å¢ï¼šåº•éƒ¨ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–/æ¨¡å¼ === */
        .sub-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-top: 10px;
        }

        .sub-cover-wrap {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        /* ç®€å•çš„æ ‡ç­¾æç¤º */
        .sub-cover-wrap::after {
            content: attr(data-label);
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 9px;
            text-align: center;
            padding: 2px 0;
            backdrop-filter: blur(2px);
        }

        .sub-cover-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sub-cover-wrap:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .mode-icon {
            width: 24px;
            height: 24px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mode-icon svg {
            fill: #fff;
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* === å³ä¾§ï¼šæ­Œè¯åŒºåŸŸ (ä¿æŒä¸å˜) === */
        .lyrics-section {
            flex: 1.5;
            height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            scrollbar-width: none;
        }
        .lyrics-section::-webkit-scrollbar { display: none; }

        .lyrics-container { padding: 50vh 0; width: 100%; }

        .lrc-line {
            padding: 12px 20px;
            margin-left: 20px;
            border-radius: 8px;
            text-align: left;
            cursor: default;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(0.95);
            transform-origin: left center;
        }

        .yrc-word-box { display: inline-block; position: relative; }
        .yrc-word-base { color: var(--inactive-color); white-space: pre-wrap; }
        .yrc-word-mask {
            position: absolute; top: 0; left: 0; color: var(--active-color); white-space: pre-wrap; width: 100%; opacity: 0;
            --gradient-stop: var(--word-pct);
            --gradient-end: calc(var(--word-pct) + var(--gradient-feather));
            -webkit-mask-image: linear-gradient(to right, black 0%, black var(--gradient-stop), transparent var(--gradient-end));
            mask-image: linear-gradient(to right, black 0%, black var(--gradient-stop), transparent var(--gradient-end));
            will-change: mask-image, opacity; pointer-events: none;
        }

        .lrc-text { font-size: 26px; font-weight: 700; color: var(--inactive-color); line-height: 1.4; transition: color 0.4s; }
        .lrc-line .trans { display: block; font-size: 18px; font-weight: 400; margin-top: 6px; opacity: 0.7; color: var(--inactive-color); transition: color 0.4s; }
        .lrc-line .roma { display: block; font-size: 16px; font-weight: 400; margin-bottom: 4px; opacity: 0.6; color: var(--inactive-color); font-style: italic; transition: color 0.4s; }

        .lrc-line.active { transform: scale(1); }
        .lrc-line.active .lrc-text { color: var(--active-color); font-size: 32px; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .lrc-line.active .trans { color: rgba(255,255,255,0.9); opacity: 1; }
        .lrc-line.active .roma { color: rgba(255,255,255,0.8); opacity: 1; }
        
        .yrc-line-content { font-size: 28px; font-weight: 700; line-height: 1.4; }
        .lrc-line.active .yrc-line-content { font-size: 34px; }

        @media (max-width: 768px) {
            .container { flex-direction: column; padding: 20px; }
            .info-section { flex: 0 0 auto; margin-bottom: 20px; width: 100%; padding-bottom: 0;}
            .album-art { width: 200px; height: 200px; margin-bottom: 15px; }
            .sub-controls { display: none; /* ç§»åŠ¨ç«¯å¤ªæŒ¤äº†ï¼Œéšè—åº•éƒ¨æ§åˆ¶ */ }
            .progress-container { width: 100%; margin-bottom: 15px;}
            .song-title { font-size: 24px; }
            .lyrics-section { width: 100%; height: 50vh; }
            .lrc-line { text-align: center; margin-left: 0; transform-origin: center center; }
            .yrc-line-content { font-size: 22px; }
            .lrc-line.active .yrc-line-content { font-size: 26px; }
        }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="container">
        <!-- å·¦ä¾§ä¿¡æ¯åŒº -->
        <div class="info-section">
            <img src="" alt="Album Art" class="album-art" id="cover-img">
            
            <div class="text-group">
                <h1 class="song-title" id="title">Waiting...</h1>
                <h2 class="artist-name" id="artist">è¯·æ’­æ”¾ç½‘æ˜“äº‘éŸ³ä¹</h2>
            </div>

            <!-- æ–°å¢ï¼šè¿›åº¦æ¡ -->
            <div class="progress-container">
                <span class="time-label" id="curr-time-text">00:00</span>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <span class="time-label" id="total-time-text">00:00</span>
            </div>

            <!-- æ–°å¢ï¼šä¸Šä¸€é¦–/æ¨¡å¼/ä¸‹ä¸€é¦– -->
            <div class="sub-controls">
                <div class="sub-cover-wrap" data-label="PREV">
                    <img id="prev-cover" src="" onerror="this.style.opacity=0">
                </div>
                
                <div class="mode-icon" id="mode-icon-container">
                    <!-- SVGå›¾æ ‡å°†é€šè¿‡JSæ’å…¥ -->
                </div>

                <div class="sub-cover-wrap" data-label="NEXT">
                    <img id="next-cover" src="" onerror="this.style.opacity=0">
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ­Œè¯åŒº -->
        <div class="lyrics-section" id="lyrics-viewport">
            <div class="lyrics-container" id="lyrics-box"></div>
        </div>
    </div>

    <script>
        // æ›¿æ¢ä¸ºä½ çš„ Python æœåŠ¡ IP
        const BASE_URL = "http://192.168.31.22:18726";
        const DEFAULT_COVER = "https://p2.music.126.net/tGHU62DTbzHOs014gv0zkA==/18806046882229308.jpg";

        // DOM å…ƒç´ 
        const elBg = document.getElementById('bg-layer');
        const elCover = document.getElementById('cover-img');
        const elTitle = document.getElementById('title');
        const elArtist = document.getElementById('artist');
        const elLyricsBox = document.getElementById('lyrics-box');
        const elViewport = document.getElementById('lyrics-viewport');
        
        // æ–°å¢ DOM
        const elProgFill = document.getElementById('progress-fill');
        const elCurrTime = document.getElementById('curr-time-text');
        const elTotalTime = document.getElementById('total-time-text');
        const elPrevCover = document.getElementById('prev-cover');
        const elNextCover = document.getElementById('next-cover');
        const elModeContainer = document.getElementById('mode-icon-container');

        // çŠ¶æ€å˜é‡
        let currentSongId = 0;
        let lyricsData = []; 
        let lastActiveIndex = -1;
        let isFetchingLyrics = false;

        let lastServerTime = 0; 
        let lastLocalTick = 0;  
        let isPlaying = false;  
        let lastRenderedTime = 0; 
        let currentTotalDuration = 0;

        // åˆå§‹åŒ–
        elCover.src = DEFAULT_COVER;
        elBg.style.backgroundImage = `url("${DEFAULT_COVER}")`;
        elPrevCover.src = DEFAULT_COVER;
        elNextCover.src = DEFAULT_COVER;

        async function fetchState() {
            try {
                const response = await fetch(`${BASE_URL}/info?t=${Date.now()}`);
                const data = await response.json();
                if(data && data.basic_info) {
                    updatePlaybackUI(data);
                }
            } catch (e) {}
        }

        function updatePlaybackUI(data) {
            const info = data.basic_info;
            const playback = data.playback;

            // 1. è¿›åº¦åŒæ­¥é€»è¾‘
            if (playback && playback.current_sec !== undefined) {
                // å¦‚æœåç«¯æ˜¾ç¤ºæš‚åœï¼Œå¼ºåˆ¶æ ¡å‡†æ—¶é—´
                if (!data.playing) {
                    lastRenderedTime = playback.current_sec;
                }
                // å¦‚æœè¯¯å·®è¿‡å¤§ï¼Œå¼ºåˆ¶æ ¡å‡†
                if (Math.abs(playback.current_sec - lastRenderedTime) > 0.5) {
                    lastRenderedTime = playback.current_sec; 
                }

                lastServerTime = playback.current_sec;
                currentTotalDuration = playback.total_sec || info.duration / 1000 || 0;
                lastLocalTick = Date.now();
                isPlaying = data.playing;

                // æ›´æ–°æ€»æ—¶é•¿æ–‡å­— (åªéœ€æ›´æ–°ä¸€æ¬¡æˆ–å˜åŒ–æ—¶æ›´æ–°)
                elTotalTime.innerText = playback.formatted_total || formatTime(currentTotalDuration);
                
                // æ›´æ–°æ’­æ”¾æ¨¡å¼å›¾æ ‡
                if (playback.play_mode) {
                    elModeContainer.innerHTML = getModeIcon(playback.play_mode);
                }

                // æ›´æ–°é‚»å±…å°é¢
                if (playback.prev_song && playback.prev_song.cover) {
                    if (elPrevCover.src !== playback.prev_song.cover) elPrevCover.src = playback.prev_song.cover;
                    elPrevCover.style.opacity = '1';
                } else {
                    elPrevCover.style.opacity = '0'; // æ²¡æœ‰ä¸Šä¸€é¦–æ—¶éšè—
                }

                if (playback.next_song && playback.next_song.cover) {
                    if (elNextCover.src !== playback.next_song.cover) elNextCover.src = playback.next_song.cover;
                    elNextCover.style.opacity = '1';
                } else {
                    elNextCover.style.opacity = '0';
                }
            }

            // 2. åˆ‡æ­Œé€»è¾‘
            if (info.id !== 0) {
                if (info.id !== currentSongId) {
                    console.log(`[Frontend] åˆ‡æ­Œ: ${info.name}`);
                    elTitle.innerText = info.name || "æœªçŸ¥æ­Œæ›²";
                    elArtist.innerText = info.artist || "æœªçŸ¥æ­Œæ‰‹";
                    
                    let coverUrl = info.cover_url || DEFAULT_COVER;
                    elCover.src = coverUrl;
                    elBg.style.backgroundImage = `url("${coverUrl}")`;

                    currentSongId = info.id;
                    lyricsData = [];
                    lastActiveIndex = -1;
                    elLyricsBox.innerHTML = '<div class="lrc-line" style="text-align:center; opacity:0.5;">æ­£åœ¨åŠ è½½æ­Œè¯...</div>';
                    
                    fetchLyrics();
                } else if (lyricsData.length === 0 && !isFetchingLyrics) {
                    // è¡¥æ¼åŠ è½½
                    fetchLyrics();
                }
            }

            if (data.playing) elCover.classList.add('playing');
            else elCover.classList.remove('playing');
        }

        // æ¸²æŸ“å¾ªç¯ (60FPS)
        function renderLoop() {
            let preciseTime = lastServerTime;
            if (isPlaying) {
                const elapsed = (Date.now() - lastLocalTick) / 1000;
                preciseTime += elapsed;
            }

            // é˜²æ­¢å€’æµ
            if (preciseTime < lastRenderedTime) {
                preciseTime = lastRenderedTime; 
            }
            lastRenderedTime = preciseTime;

            // 1. æ›´æ–°è¿›åº¦æ¡ (å¹³æ»‘åŠ¨ç”»)
            if (currentTotalDuration > 0) {
                const pct = Math.min(100, Math.max(0, (preciseTime / currentTotalDuration) * 100));
                elProgFill.style.width = `${pct}%`;
                elCurrTime.innerText = formatTime(preciseTime);
            }

            // 2. åŒæ­¥æ­Œè¯
            syncLyrics(preciseTime);
            
            // 3. æ›´æ–°é€å­—æ­Œè¯æ¸å˜
            updateWordGradients(preciseTime);

            requestAnimationFrame(renderLoop);
        }

        // SVG å›¾æ ‡åº“
        function getModeIcon(mode) {
            const commonStyle = 'viewBox="0 0 24 24"';
            // åˆ—è¡¨å¾ªç¯
            if (mode === 'list' || mode === 'loop') return `<svg ${commonStyle}><path d="M17 17H7v-3l-4 4 4 4v-3h12v-6h-2v4zm0-12v3h-12v6h-2v-8h14zm-4 4l4-4-4-4v3h-12v6h2v-4h10z"/></svg>`;
            // å•æ›²å¾ªç¯
            if (mode === 'single' || mode === 'singleloop') return `<svg ${commonStyle}><path d="M17 17H7v-3l-4 4 4 4v-3h12v-6h-2v4zm0-12v3h-12v6h-2v-8h14zm-4 4l4-4-4-4v3h-12v6h2v-4h10z"/><text x="10" y="16" font-size="8" fill="white" font-weight="bold">1</text></svg>`;
            // éšæœºæ’­æ”¾
            if (mode === 'random' || mode === 'shuffle') return `<svg ${commonStyle}><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>`;
            // é¡ºåºæ’­æ”¾
            return `<svg ${commonStyle}><path d="M3 15h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V9H3v2zm0-6v2h18V5H3z"/></svg>`;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // --- ä»¥ä¸‹æ­Œè¯è§£æå‡½æ•°ä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼Œçœç•¥é‡å¤ä»£ç ä»¥èŠ‚çœç©ºé—´ ---
        // (è¯·ä¿ç•™åŸæ¥çš„ fetchLyrics, parseLrcLine, parseYrc, parseAndMergeAll, renderLyrics, syncLyrics, updateWordGradients å‡½æ•°)
        
        async function fetchLyrics() { /* ...åŒå‰... */ 
            if (isFetchingLyrics) return;
            isFetchingLyrics = true;
            try {
                const response = await fetch(`${BASE_URL}/lyrics?t=${Date.now()}`);
                const data = await response.json();
                if (data.id !== currentSongId) return;
                if (data.hasLyric || data.hasYrc) {
                    const parsed = parseAndMergeAll(data);
                    renderLyrics(parsed);
                } else { renderLyrics([]); }
            } catch (e) { console.error(e); } finally { isFetchingLyrics = false; }
        }
        function parseLrcLine(text) { /* ...åŒå‰... */ 
            if (!text) return {}; const lines = text.split('\n'); const result = {}; const regex = /\[(\d{2}):(\d{2})(?:[\.:](\d+))?\](.*)/;
            lines.forEach(line => { const match = line.match(regex); if (match) { const min = parseInt(match[1]); const sec = parseInt(match[2]); let msVal = 0; const msStr = match[3] || "0"; if (msStr.length === 2) msVal = parseInt(msStr) / 100; else if (msStr.length === 3) msVal = parseInt(msStr) / 1000; const content = match[4].trim(); if (content) { const time = min * 60 + sec + msVal; result[time.toFixed(3)] = content; } } }); return result;
        }
        function parseYrc(text) { /* ...åŒå‰... */
            if (!text) return []; const lines = text.split('\n'); const result = []; const lineRegex = /^\[(\d+),(\d+)\](.*)/; const wordRegex = /\((\d+),(\d+),(\d+)\)([^\(]+)/g;
            lines.forEach(line => { const match = line.match(lineRegex); if (match) { const startTime = parseInt(match[1]) / 1000; const duration = parseInt(match[2]) / 1000; const contentRaw = match[3]; const words = []; let wordMatch; let fullText = ""; while ((wordMatch = wordRegex.exec(contentRaw)) !== null) { const wStart = parseInt(wordMatch[1]) / 1000; const wDur = parseInt(wordMatch[2]) / 1000; const wTxt = wordMatch[4]; fullText += wTxt; words.push({ time: wStart, duration: wDur, text: wTxt }); } if (fullText) { result.push({ time: startTime, duration: duration, text: fullText, words: words, isYrc: true }); } } }); return result;
        }
        function parseAndMergeAll(packet) { /* ...åŒå‰... */
            const lrcMap = parseLrcLine(packet.lrc); const transMap = parseLrcLine(packet.tlyric); const romaMap = parseLrcLine(packet.romalrc); const lrcTimeline = Object.keys(lrcMap).sort((a, b) => parseFloat(a) - parseFloat(b)); const enrichedLrc = lrcTimeline.map(tStr => { const t = parseFloat(tStr); const text = lrcMap[tStr]; const findInMap = (map) => { for (const k in map) { if (Math.abs(parseFloat(k) - t) < 0.2) return map[k]; } return ""; }; return { time: t, text: text, trans: findInMap(transMap), roma: findInMap(romaMap), normalizedText: text.replace(/[^\w\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g, '').toLowerCase() }; }); if (!packet.hasYrc || !packet.yrc) { return enrichedLrc.map(item => ({ ...item, isYrc: false })); } const yrcLines = parseYrc(packet.yrc); return yrcLines.map(yLine => { const yTextNorm = yLine.text.replace(/[^\w\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g, '').toLowerCase(); let match = null; if (yTextNorm.length > 0) { match = enrichedLrc.find(l => { if (!l.normalizedText) return false; return l.normalizedText === yTextNorm || l.normalizedText.includes(yTextNorm) || yTextNorm.includes(l.normalizedText); }); } if (!match) { match = enrichedLrc.find(l => Math.abs(l.time - yLine.time) < 1.5); } return { ...yLine, isYrc: true, trans: match ? match.trans : "", roma: match ? match.roma : "" }; });
        }
        function renderLyrics(lyrics) { /* ...åŒå‰... */
            lyricsData = lyrics; elLyricsBox.innerHTML = ""; lastActiveIndex = -1; if (!lyrics || lyrics.length === 0) { elLyricsBox.innerHTML = '<div class="lrc-line" style="text-align:center; opacity:0.5;">ğŸµ çº¯éŸ³ä¹ / æš‚æ— æ­Œè¯</div>'; return; } const fragment = document.createDocumentFragment(); lyrics.forEach((line, index) => { const div = document.createElement('div'); div.className = 'lrc-line'; div.id = `line-${index}`; let html = ``; if (line.roma) html += `<span class="roma">${line.roma}</span>`; if (line.isYrc && line.words && line.words.length > 0) { html += `<div class="yrc-line-content">`; line.words.forEach((w) => { html += `<span class="yrc-word-box"><span class="yrc-word-base">${w.text}</span><span class="yrc-word-mask" data-start="${w.time}" data-dur="${w.duration}" style="--word-pct: 0%">${w.text}</span></span>`; }); html += `</div>`; } else { html += `<div class="lrc-text">${line.text}</div>`; } if (line.trans) html += `<span class="trans">${line.trans}</span>`; div.innerHTML = html; fragment.appendChild(div); }); elLyricsBox.appendChild(fragment);
        }
        function syncLyrics(currentTime) { /* ...åŒå‰... */
            if (!lyricsData.length) return; let activeIndex = -1; for (let i = lyricsData.length - 1; i >= 0; i--) { if (currentTime >= lyricsData[i].time) { activeIndex = i; break; } } if (activeIndex !== lastActiveIndex) { const lines = elLyricsBox.children; if (lastActiveIndex >= 0 && lastActiveIndex < lines.length) { const prevLine = lines[lastActiveIndex]; prevLine.classList.remove('active'); const masks = prevLine.querySelectorAll('.yrc-word-mask'); masks.forEach(w => { w.style.setProperty('--word-pct', '0%'); w.style.opacity = '0'; }); } if (activeIndex >= 0 && activeIndex < lines.length) { const activeLine = lines[activeIndex]; activeLine.classList.add('active'); const offset = activeLine.offsetTop - (elViewport.clientHeight / 2) + (activeLine.clientHeight / 2); elViewport.scrollTo({ top: offset, behavior: 'smooth' }); const masks = activeLine.querySelectorAll('.yrc-word-mask'); masks.forEach(w => { w.style.setProperty('--word-pct', '0%'); w.style.opacity = '0'; }); } lastActiveIndex = activeIndex; }
        }
        function updateWordGradients(currentTime) { /* ...åŒå‰... */
            if (lastActiveIndex < 0 || lastActiveIndex >= lyricsData.length) return; const lineData = lyricsData[lastActiveIndex]; if (!lineData.isYrc) return; const lineEl = document.getElementById(`line-${lastActiveIndex}`); if (!lineEl) return; const masks = lineEl.querySelectorAll('.yrc-word-mask'); masks.forEach(w => { const start = parseFloat(w.dataset.start); const dur = parseFloat(w.dataset.dur); const end = start + dur; let pct = 0; if (currentTime < start) { pct = 0; } else if (currentTime >= end) { pct = 100; } else { pct = ((currentTime - start) / dur) * 100; } if (pct <= 0) { w.style.opacity = '0'; } else { w.style.opacity = '1'; } w.style.setProperty('--word-pct', `${pct.toFixed(2)}%`); });
        }

        setInterval(fetchState, 500); 
        fetchState();
        requestAnimationFrame(renderLoop); 
    </script>
</body>
</html>