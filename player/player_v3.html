<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />
    <title>Netease Music Player</title>
    <style>
        :root {
            --active-color: #ffffff;
            --inactive-color: rgba(255, 255, 255, 0.45); 
            --blur-intensity: 60px;
            --gradient-feather: 20px; 
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #000;
            user-select: none;
        }

        /* === åŒå±‚èƒŒæ™¯ç³»ç»Ÿï¼ˆæ‰«æçº¿æ•ˆæœï¼‰ === */
        .bg-layer {
            position: fixed;
            top: -100px; left: -100px; right: -100px; bottom: -100px;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            filter: blur(var(--blur-intensity)) brightness(0.5);
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .bg-layer.active {
            opacity: 1;
        }

        /* ä»å·¦åˆ°å³æ‰«æï¼ˆä¸Šä¸€é¦–ï¼‰ - è¦†ç›–transitionï¼Œä½¿ç”¨åŠ¨ç”» */
        .bg-layer.scan-left-to-right {
            animation: scanlineLeftToRight 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            transition: none;
        }

        /* ä»å³åˆ°å·¦æ‰«æï¼ˆä¸‹ä¸€é¦–ï¼‰ - è¦†ç›–transitionï¼Œä½¿ç”¨åŠ¨ç”» */
        .bg-layer.scan-right-to-left {
            animation: scanlineRightToLeft 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            transition: none;
        }

        @keyframes scanlineLeftToRight {
            from {
                opacity: 1;
                clip-path: polygon(0 0, 0 0, 0 100%, 0 100%);
            }
            to {
                opacity: 1;
                clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
            }
        }

        @keyframes scanlineRightToLeft {
            from {
                opacity: 1;
                clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%);
            }
            to {
                opacity: 1;
                clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
            }
        }

        #bg-layer-1 { z-index: 1; }
        #bg-layer-2 { z-index: 1; }

        .container {
            position: relative;
            z-index: 10;
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }

        /* === å·¦ä¾§ä¿¡æ¯åŒº === */
        .info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 450px;
            padding-bottom: 20px; 
        }

        /* === åŒå±‚å°é¢ç³»ç»Ÿ === */
        .album-art-container {
            position: relative;
            width: 320px;
            height: 320px;
            margin-bottom: 25px;
        }

        .album-art {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            object-fit: cover;
            background-color: rgba(255,255,255,0.1);
            opacity: 0;
            transform: scale(0.8);
            transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1;
        }

        .album-art.active {
            opacity: 1;
            transform: scale(1);
            z-index: 2;
        }

        /* ç§»é™¤å‘¼å¸æ•ˆæœï¼Œåªä¿ç•™é˜´å½± */
        .album-art.playing {
            box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 40px rgba(255,255,255,0.1);
        }

        /* é£è¡ŒåŠ¨ç”» - 4ä¸ªæ–¹å‘ */
        .album-art.fly-from-next {
            animation: flyFromNext 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .album-art.fly-from-prev {
            animation: flyFromPrev 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .album-art.fly-to-prev {
            animation: flyToPrev 1s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards;
        }

        .album-art.fly-to-next {
            animation: flyToNext 1s cubic-bezier(0.6, -0.28, 0.74, 0.05) forwards;
        }

        /* ä»å³ä¸‹æ–¹çš„ä¸‹ä¸€é¦–å°é¢é£å…¥ */
        @keyframes flyFromNext {
            from {
                opacity: 1;
                transform: translate(66px, 380px) scale(0.156);
            }
            to {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
        }

        /* ä»å·¦ä¸‹æ–¹çš„ä¸Šä¸€é¦–å°é¢é£å…¥ */
        @keyframes flyFromPrev {
            from {
                opacity: 1;
                transform: translate(-66px, 380px) scale(0.156);
            }
            to {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
        }

        /* é£å‡ºåˆ°å·¦ä¸‹æ–¹çš„ä¸Šä¸€é¦–å°é¢ */
        @keyframes flyToPrev {
            from {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(-66px, 380px) scale(0.156);
            }
        }

        /* é£å‡ºåˆ°å³ä¸‹æ–¹çš„ä¸‹ä¸€é¦–å°é¢ */
        @keyframes flyToNext {
            from {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            to {
                opacity: 0;
                transform: translate(66px, 380px) scale(0.156);
            }
        }

        .text-group {
            margin-bottom: 20px;
            width: 100%;
            overflow: hidden;
        }

        .song-title {
            font-size: 28px;
            font-weight: 800;
            margin: 0 0 8px 0;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .song-title.show {
            opacity: 1;
            transform: translateY(0);
        }

        .artist-name {
            font-size: 18px;
            color: rgba(255,255,255,0.8);
            margin: 0;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s;
        }

        .artist-name.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* === è¿›åº¦æ¡åŒºåŸŸ === */
        .progress-container {
            width: 80%;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s;
        }

        .progress-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .time-label {
            font-size: 12px;
            font-variant-numeric: tabular-nums;
            color: rgba(255,255,255,0.6);
            min-width: 35px;
        }

        .progress-bar-bg {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: height 0.2s ease;
        }

        .progress-bar-bg:hover {
            height: 6px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.8), rgba(255,255,255,1));
            width: 0%;
            border-radius: 2px;
            position: relative;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .progress-bar-bg:hover .progress-bar-fill::after {
            opacity: 1;
        }

        /* === åº•éƒ¨æ§åˆ¶åŒº === */
        .sub-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-top: 10px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s;
        }

        .sub-controls.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* å°å°é¢å®¹å™¨ï¼ˆåŒå±‚ï¼‰ */
        .sub-cover-wrap {
            position: relative;
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0.6;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            cursor: pointer;
        }

        .sub-cover-wrap img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sub-cover-wrap img.active {
            opacity: 1;
        }
        
        .sub-cover-wrap::after {
            content: attr(data-label);
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 9px;
            text-align: center;
            padding: 2px 0;
            backdrop-filter: blur(2px);
            transition: all 0.3s;
            z-index: 10;
        }

        .sub-cover-wrap:hover {
            opacity: 1;
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .sub-cover-wrap:active {
            transform: translateY(-2px) scale(1);
        }

        .mode-icon {
            width: 32px;
            height: 32px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .mode-icon:hover {
            opacity: 1;
            background: rgba(255,255,255,0.1);
            transform: scale(1.15) rotate(15deg);
        }

        .mode-icon:active {
            transform: scale(0.95);
        }

        .mode-icon svg {
            fill: #fff;
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* === æ­Œè¯åŒºåŸŸ === */
        .lyrics-section {
            flex: 1.5;
            height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            scrollbar-width: none;
        }
        .lyrics-section::-webkit-scrollbar { display: none; }

        .lyrics-container { 
            padding: 50vh 0; 
            width: 100%;
            opacity: 0;
            transition: opacity 0.6s ease 0.4s;
        }

        .lyrics-container.show {
            opacity: 1;
        }

        .lrc-line {
            padding: 12px 20px;
            margin-left: 20px;
            border-radius: 8px;
            text-align: left;
            cursor: default;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(0.95);
            transform-origin: left center;
            opacity: 0;
            animation: fadeInLyric 0.5s ease forwards;
        }

        @keyframes fadeInLyric {
            from {
                opacity: 0;
                transform: scale(0.95) translateX(-20px);
            }
            to {
                opacity: 1;
                transform: scale(0.95) translateX(0);
            }
        }

        .yrc-word-box { 
            display: inline-block; 
            position: relative; 
        }

        .yrc-word-base { 
            color: var(--inactive-color); 
            white-space: pre-wrap; 
        }

        .yrc-word-mask {
            position: absolute; 
            top: 0; 
            left: 0; 
            color: var(--active-color); 
            white-space: pre-wrap; 
            width: 100%; 
            opacity: 0;
            --gradient-stop: var(--word-pct);
            --gradient-end: calc(var(--word-pct) + var(--gradient-feather));
            -webkit-mask-image: linear-gradient(to right, black 0%, black var(--gradient-stop), transparent var(--gradient-end));
            mask-image: linear-gradient(to right, black 0%, black var(--gradient-stop), transparent var(--gradient-end));
            will-change: mask-image, opacity; 
            pointer-events: none;
        }

        .lrc-text { 
            font-size: 26px; 
            font-weight: 700; 
            color: var(--inactive-color); 
            line-height: 1.4; 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lrc-line .trans { 
            display: block; 
            font-size: 18px; 
            font-weight: 400; 
            margin-top: 6px; 
            opacity: 0.7; 
            color: var(--inactive-color); 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lrc-line .roma { 
            display: block; 
            font-size: 16px; 
            font-weight: 400; 
            margin-bottom: 4px; 
            opacity: 0.6; 
            color: var(--inactive-color); 
            font-style: italic; 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lrc-line.active { 
            transform: scale(1); 
        }

        .lrc-line.active .lrc-text { 
            color: var(--active-color); 
            font-size: 32px; 
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        .lrc-line.active .trans { 
            color: rgba(255,255,255,0.9); 
            opacity: 1; 
        }

        .lrc-line.active .roma { 
            color: rgba(255,255,255,0.8); 
            opacity: 1; 
        }
        
        .yrc-line-content { 
            font-size: 28px; 
            font-weight: 700; 
            line-height: 1.4; 
            transition: font-size 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .lrc-line.active .yrc-line-content { 
            font-size: 34px; 
        }

        /* === åŠ è½½åŠ¨ç”» === */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .loading-shimmer {
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.05) 0%, 
                rgba(255,255,255,0.15) 50%, 
                rgba(255,255,255,0.05) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @media (max-width: 768px) {
            .container { 
                flex-direction: column; 
                padding: 20px; 
            }

            .info-section { 
                flex: 0 0 auto; 
                margin-bottom: 20px; 
                width: 100%; 
                padding-bottom: 0;
            }

            .album-art-container { 
                width: 200px; 
                height: 200px; 
                margin-bottom: 15px; 
            }

            .sub-controls { 
                display: none; 
            }

            .progress-container { 
                width: 100%; 
                margin-bottom: 15px;
            }

            .song-title { 
                font-size: 24px; 
            }

            .lyrics-section { 
                width: 100%; 
                height: 50vh; 
            }

            .lrc-line { 
                text-align: center; 
                margin-left: 0; 
                transform-origin: center center; 
            }

            .yrc-line-content { 
                font-size: 22px; 
            }

            .lrc-line.active .yrc-line-content { 
                font-size: 26px; 
            }
        }
    </style>
</head>
<body>

    <!-- åŒå±‚èƒŒæ™¯ -->
    <div class="bg-layer" id="bg-layer-1"></div>
    <div class="bg-layer" id="bg-layer-2"></div>

    <div class="container">
        <!-- å·¦ä¾§ä¿¡æ¯åŒº -->
        <div class="info-section">
            <!-- åŒå±‚å°é¢ -->
            <div class="album-art-container">
                <img src="" alt="Album Art" class="album-art" id="cover-img-1">
                <img src="" alt="Album Art" class="album-art" id="cover-img-2">
            </div>
            
            <div class="text-group">
                <h1 class="song-title" id="title">Waiting...</h1>
                <h2 class="artist-name" id="artist">è¯·æ’­æ”¾ç½‘æ˜“äº‘éŸ³ä¹</h2>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-container">
                <span class="time-label" id="curr-time-text">00:00</span>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <span class="time-label" id="total-time-text">00:00</span>
            </div>

            <!-- ä¸Šä¸€é¦–/æ¨¡å¼/ä¸‹ä¸€é¦– -->
            <div class="sub-controls">
                <div class="sub-cover-wrap" id="prev-wrap" data-label="PREV">
                    <img class="prev-img" src="">
                    <img class="prev-img" src="">
                </div>
                
                <div class="mode-icon" id="mode-icon-container">
                    <!-- SVGå›¾æ ‡å°†é€šè¿‡JSæ’å…¥ -->
                </div>

                <div class="sub-cover-wrap" id="next-wrap" data-label="NEXT">
                    <img class="next-img" src="">
                    <img class="next-img" src="">
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ­Œè¯åŒº -->
        <div class="lyrics-section" id="lyrics-viewport">
            <div class="lyrics-container" id="lyrics-box"></div>
        </div>
    </div>

    <script>
        // æ›¿æ¢ä¸ºä½ çš„ Python æœåŠ¡ IP
        const BASE_URL = "http://192.168.31.22:18726";
        const DEFAULT_COVER = "https://p2.music.126.net/tGHU62DTbzHOs014gv0zkA==/18806046882229308.jpg";

        // DOM å…ƒç´ 
        const elBg1 = document.getElementById('bg-layer-1');
        const elBg2 = document.getElementById('bg-layer-2');
        const elCover1 = document.getElementById('cover-img-1');
        const elCover2 = document.getElementById('cover-img-2');
        const elTitle = document.getElementById('title');
        const elArtist = document.getElementById('artist');
        const elLyricsBox = document.getElementById('lyrics-box');
        const elViewport = document.getElementById('lyrics-viewport');
        
        const elProgFill = document.getElementById('progress-fill');
        const elCurrTime = document.getElementById('curr-time-text');
        const elTotalTime = document.getElementById('total-time-text');
        const elModeContainer = document.getElementById('mode-icon-container');
        const elProgressContainer = document.querySelector('.progress-container');
        const elSubControls = document.querySelector('.sub-controls');

        // å°å°é¢å…ƒç´ 
        const elPrevImgs = document.querySelectorAll('.prev-img');
        const elNextImgs = document.querySelectorAll('.next-img');

        // çŠ¶æ€å˜é‡
        let currentSongId = 0;
        let previousNextSongId = 0; // è®°å½•ä¸Šæ¬¡çš„ä¸‹ä¸€é¦–æ­Œæ›²ID
        let previousPrevSongId = 0; // è®°å½•ä¸Šæ¬¡çš„ä¸Šä¸€é¦–æ­Œæ›²ID
        let lyricsData = []; 
        let lastActiveIndex = -1;
        let isFetchingLyrics = false;

        let lastServerTime = 0; 
        let lastLocalTick = 0;  
        let isPlaying = false;  
        let lastRenderedTime = 0; 
        let currentTotalDuration = 0;

        // åŒå±‚ç³»ç»ŸçŠ¶æ€
        let activeCoverLayer = 1; // 1 æˆ– 2
        let activeBgLayer = 1;

        // å›¾ç‰‡é¢„åŠ è½½ç¼“å­˜
        const imageCache = new Map();

        // åˆå§‹åŒ–
        preloadAndSetImage(elCover1, DEFAULT_COVER, true);
        preloadAndSetImage(elBg1, DEFAULT_COVER, false);
        elBg1.classList.add('active'); // åˆå§‹èƒŒæ™¯ä¸éœ€è¦æ‰«æåŠ¨ç”»
        elBg1.style.zIndex = '2'; // åˆå§‹æ¿€æ´»å±‚è®¾ä¸ºè¾ƒé«˜çš„z-index
        elCover1.classList.add('active');

        // ä»…é¢„åŠ è½½å›¾ç‰‡åˆ°ç¼“å­˜ï¼Œä¸è®¾ç½®åˆ°å…ƒç´ 
        function preloadImageToCache(url) {
            if (!url || imageCache.has(url)) {
                return Promise.resolve();
            }

            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    imageCache.set(url, true);
                    console.log(`[é¢„åŠ è½½] æˆåŠŸç¼“å­˜å›¾ç‰‡: ${url.substring(url.lastIndexOf('/') + 1)}`);
                    resolve();
                };
                img.onerror = () => {
                    resolve(); // å³ä½¿å¤±è´¥ä¹Ÿresolveï¼Œé¿å…é˜»å¡
                };
                img.src = url;
            });
        }

        // å›¾ç‰‡é¢„åŠ è½½å‡½æ•°
        function preloadAndSetImage(element, url, isCover) {
            return new Promise((resolve, reject) => {
                if (!url) {
                    reject('No URL provided');
                    return;
                }

                // æ£€æŸ¥ç¼“å­˜
                if (imageCache.has(url)) {
                    console.log(`[é¢„åŠ è½½] ç¼“å­˜å‘½ä¸­: ${url.substring(url.lastIndexOf('/') + 1)}`);
                    if (isCover) {
                        element.src = url;
                    } else {
                        element.style.backgroundImage = `url("${url}")`;
                    }
                    resolve();
                    return;
                }

                // é¢„åŠ è½½å›¾ç‰‡
                const img = new Image();
                img.onload = () => {
                    imageCache.set(url, true);
                    if (isCover) {
                        element.src = url;
                    } else {
                        element.style.backgroundImage = `url("${url}")`;
                    }
                    resolve();
                };
                img.onerror = () => {
                    console.warn(`Failed to load image: ${url}`);
                    reject();
                };
                img.src = url;
            });
        }

        // åˆ‡æ¢å°é¢ï¼ˆé£è¡ŒåŠ¨ç”»ï¼‰
        // direction: 'next' (ä»å³ä¸‹é£å…¥ï¼Œåˆ°å·¦ä¸‹é£å‡º) æˆ– 'prev' (ä»å·¦ä¸‹é£å…¥ï¼Œåˆ°å³ä¸‹é£å‡º)
        function switchCoverWithFly(newUrl, direction = 'next') {
            const currentLayer = activeCoverLayer;
            const nextLayer = currentLayer === 1 ? 2 : 1;
            const currentEl = currentLayer === 1 ? elCover1 : elCover2;
            const nextEl = nextLayer === 1 ? elCover1 : elCover2;

            // ç«‹å³å¯åŠ¨åŠ¨ç”»ï¼Œä¸ç­‰å¾…å›¾ç‰‡åŠ è½½
            // ç§»é™¤æ‰€æœ‰åŠ¨ç”»ç±»
            currentEl.classList.remove('fly-from-next', 'fly-from-prev', 'fly-to-prev', 'fly-to-next');
            nextEl.classList.remove('fly-from-next', 'fly-from-prev', 'fly-to-prev', 'fly-to-next');

            // å¼ºåˆ¶é‡æ’
            void nextEl.offsetWidth;
            void currentEl.offsetWidth;

            // æ ¹æ®æ–¹å‘åº”ç”¨åŠ¨ç”»
            if (direction === 'prev') {
                // åˆ‡ä¸Šä¸€é¦–ï¼šæ–°å°é¢ä»å·¦ä¸‹é£å…¥ï¼Œæ—§å°é¢é£åˆ°å³ä¸‹
                currentEl.classList.add('fly-to-next');
                nextEl.classList.add('fly-from-prev', 'active');
            } else {
                // åˆ‡ä¸‹ä¸€é¦–ï¼šæ–°å°é¢ä»å³ä¸‹é£å…¥ï¼Œæ—§å°é¢é£åˆ°å·¦ä¸‹
                currentEl.classList.add('fly-to-prev');
                nextEl.classList.add('fly-from-next', 'active');
            }

            // æ›´æ–°æ’­æ”¾çŠ¶æ€
            if (isPlaying) {
                nextEl.classList.add('playing');
            }

            // ã€ä¼˜åŒ–ã€‘å…ˆç«‹å³å°è¯•è®¾ç½®å›¾ç‰‡ï¼Œåˆ©ç”¨æµè§ˆå™¨HTTPç¼“å­˜ï¼ˆå°å°é¢å·²åŠ è½½è¿‡çš„å›¾ç‰‡ä¼šå¾ˆå¿«æ˜¾ç¤ºï¼‰
            // ç„¶åå¼‚æ­¥é¢„åŠ è½½éªŒè¯ï¼Œç¡®ä¿å›¾ç‰‡å®Œå…¨åŠ è½½
            nextEl.src = newUrl;
            
            preloadAndSetImage(nextEl, newUrl, true).catch(e => {
                console.error('Cover load failed', e);
                // ä½¿ç”¨å ä½å›¾
                nextEl.src = DEFAULT_COVER;
            });

            // æ¸…ç†æ—§å±‚
            setTimeout(() => {
                currentEl.classList.remove('active', 'playing', 'fly-to-prev', 'fly-to-next');
                activeCoverLayer = nextLayer;
            }, 1000);
        }

        // åˆ‡æ¢èƒŒæ™¯ï¼ˆæ‰«æçº¿æ•ˆæœï¼‰
        // direction: 'next' (ä»å³åˆ°å·¦) æˆ– 'prev' (ä»å·¦åˆ°å³)
        function switchBackgroundScanline(newUrl, direction = 'next') {
            const currentLayer = activeBgLayer;
            const nextLayer = currentLayer === 1 ? 2 : 1;
            const currentEl = currentLayer === 1 ? elBg1 : elBg2;
            const nextEl = nextLayer === 1 ? elBg1 : elBg2;

            // ç«‹å³å¯åŠ¨åŠ¨ç”»ï¼Œä¸ç­‰å¾…å›¾ç‰‡åŠ è½½
            // åªç§»é™¤æ–°èƒŒæ™¯å±‚çš„æ‰€æœ‰åŠ¨ç”»ç±»ï¼ˆæ¸…ç†å¯èƒ½çš„æ®‹ç•™çŠ¶æ€ï¼‰
            nextEl.classList.remove('active', 'scan-left-to-right', 'scan-right-to-left');
            
            // åŠ¨æ€è°ƒæ•´z-indexï¼Œç¡®ä¿æ–°èƒŒæ™¯åœ¨æ—§èƒŒæ™¯ä¸Šæ–¹
            currentEl.style.zIndex = '1';
            nextEl.style.zIndex = '2';
            
            // å¼ºåˆ¶é‡æ’ï¼Œç¡®ä¿åŠ¨ç”»å¯ä»¥é‡æ–°è§¦å‘
            void nextEl.offsetWidth;

            // æ ¹æ®æ–¹å‘é€‰æ‹©æ‰«æåŠ¨ç”»ç±»
            const scanClass = direction === 'prev' ? 'scan-left-to-right' : 'scan-right-to-left';
            
            // æ·»åŠ activeå’Œå¯¹åº”çš„æ‰«æåŠ¨ç”»ï¼ˆæ–°èƒŒæ™¯ä¼šå› ä¸ºz-indexè¦†ç›–åœ¨æ—§èƒŒæ™¯ä¸Šï¼‰
            nextEl.classList.add('active', scanClass);
            
            // ã€ä¼˜åŒ–ã€‘å…ˆç«‹å³å°è¯•è®¾ç½®èƒŒæ™¯ï¼Œåˆ©ç”¨æµè§ˆå™¨HTTPç¼“å­˜ï¼ˆå°å°é¢å·²åŠ è½½è¿‡çš„å›¾ç‰‡ä¼šå¾ˆå¿«æ˜¾ç¤ºï¼‰
            // ç„¶åå¼‚æ­¥é¢„åŠ è½½éªŒè¯ï¼Œç¡®ä¿å›¾ç‰‡å®Œå…¨åŠ è½½
            nextEl.style.backgroundImage = `url("${newUrl}")`;
            
            preloadAndSetImage(nextEl, newUrl, false).catch(e => {
                console.error('Background load failed', e);
                // ä½¿ç”¨å ä½å›¾
                nextEl.style.backgroundImage = `url("${DEFAULT_COVER}")`;
            });
            
            // ç­‰å¾…æ‰«æåŠ¨ç”»å®Œæˆåï¼Œå†ç§»é™¤æ—§èƒŒæ™¯
            setTimeout(() => {
                currentEl.classList.remove('active', 'scan-left-to-right', 'scan-right-to-left');
                activeBgLayer = nextLayer;
            }, 1200);
        }

        // å­˜å‚¨æ¸…ç†å®šæ—¶å™¨çš„ Mapï¼Œkey æ˜¯å›¾ç‰‡å®¹å™¨çš„ ID æˆ– DOM å¼•ç”¨
        const fadeTimers = new Map();

        // ä¿®å¤åçš„å°å°é¢æ›´æ–°å‡½æ•°
        function updateSmallCover(imgs, newUrl) {
            // 1. å¦‚æœæ²¡æœ‰ URLï¼Œæ¸…ç©ºçŠ¶æ€
            if (!newUrl) {
                imgs.forEach(img => img.classList.remove('active'));
                return;
            }

            // 2. æ‰¾åˆ°å½“å‰æ¿€æ´»çš„å›¾å±‚ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œé»˜è®¤ç¬¬0å±‚ï¼‰
            let activeIndex = -1;
            for (let i = 0; i < imgs.length; i++) {
                if (imgs[i].classList.contains('active')) {
                    activeIndex = i;
                    break;
                }
            }
            // å¦‚æœè¿˜æ²¡åˆå§‹åŒ–ï¼Œå‡è®¾ç¬¬0å±‚æ˜¯æ¿€æ´»å±‚
            if (activeIndex === -1) activeIndex = 0;

            const currentEl = imgs[activeIndex];
            
            // === å»é‡æ£€æŸ¥ ===
            if (currentEl.src.includes(newUrl) && currentEl.classList.contains('active')) {
                return; 
            }

            // 3. ç¡®å®šä¸‹ä¸€å±‚
            const nextIndex = activeIndex === 0 ? 1 : 0;
            const nextEl = imgs[nextIndex];

            // === æ¸…ç†ä¸Šä¸€æ¬¡çš„å®šæ—¶å™¨ ===
            const container = nextEl.parentElement;
            if (fadeTimers.has(container)) {
                clearTimeout(fadeTimers.get(container));
                fadeTimers.delete(container);
            }

            // 4. ç«‹å³å¿«é€Ÿé¢„åŠ è½½å¹¶æ˜¾ç¤ºæ–°å›¾ï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
            preloadAndSetImage(nextEl, newUrl, true)
                .then(() => {
                    // ç«‹å³æ·¡å…¥æ–°å›¾
                    nextEl.classList.add('active');

                    // è®¾ç½®å®šæ—¶å™¨ï¼šç­‰æ–°å›¾å®Œå…¨æ·¡å…¥å(300ms)ï¼Œå†æ·¡å‡ºæ—§å›¾
                    const timerId = setTimeout(() => {
                        // é˜²æ­¢å¿«é€Ÿåˆ‡æ¢æ—¶æŠŠåˆšæ˜¾ç¤ºçš„å›¾ç»™åˆ äº†
                        if (currentEl !== nextEl) {
                            currentEl.classList.remove('active');
                        }
                        fadeTimers.delete(container);
                    }, 300); // ç¼©çŸ­åˆ°300msï¼Œè®©è¿‡æ¸¡æ›´å¿«æ›´æµç•…

                    fadeTimers.set(container, timerId);
                })
                .catch((e) => {
                    console.warn('Small cover load failed:', e);
                    // åŠ è½½å¤±è´¥ä¹Ÿè¯•å›¾åˆ‡æ¢æ˜¾ç¤ºï¼Œä¿æŒUIååº”
                    nextEl.classList.add('active');
                    const timerId = setTimeout(() => {
                        if (currentEl !== nextEl) {
                            currentEl.classList.remove('active');
                        }
                        fadeTimers.delete(container);
                    }, 300);
                    fadeTimers.set(container, timerId);
                });
        }

        async function fetchState() {
            try {
                const response = await fetch(`${BASE_URL}/info?t=${Date.now()}`);
                const data = await response.json();
                if(data && data.basic_info) {
                    updatePlaybackUI(data);
                }
            } catch (e) {}
        }

        function updatePlaybackUI(data) {
            const info = data.basic_info;
            const playback = data.playback;

            // 1. è¿›åº¦åŒæ­¥é€»è¾‘
            if (playback && playback.current_sec !== undefined) {
                if (!data.playing) {
                    lastRenderedTime = playback.current_sec;
                }
                if (Math.abs(playback.current_sec - lastRenderedTime) > 0.5) {
                    lastRenderedTime = playback.current_sec; 
                }

                lastServerTime = playback.current_sec;
                currentTotalDuration = playback.total_sec || info.duration / 1000 || 0;
                lastLocalTick = Date.now();
                isPlaying = data.playing;

                elTotalTime.innerText = playback.formatted_total || formatTime(currentTotalDuration);
                
                if (playback.play_mode) {
                    elModeContainer.innerHTML = getModeIcon(playback.play_mode);
                }
            }

            // 2. åˆ‡æ­Œé€»è¾‘ï¼ˆä¼˜å…ˆå¤„ç†ï¼Œå¸¦é£è¡ŒåŠ¨ç”»ï¼‰
            if (info.id !== 0) {
                if (info.id !== currentSongId) {
                    console.log(`[Frontend] åˆ‡æ­Œ: ${info.name}`);
                    console.log(`[Frontend] å½“å‰æ­Œæ›²ID: ${currentSongId}, æ–°æ­Œæ›²ID: ${info.id}`);
                    console.log(`[Frontend] ä¹‹å‰çš„ä¸Šä¸€é¦–ID: ${previousPrevSongId}, ä¹‹å‰çš„ä¸‹ä¸€é¦–ID: ${previousNextSongId}`);
                    
                    // æ£€æµ‹åˆ‡æ­Œæ–¹å‘
                    let direction = 'next'; // é»˜è®¤å‡è®¾æ˜¯ä¸‹ä¸€é¦–
                    let isDirectionDetected = false; // æ˜¯å¦ç¡®å®æ£€æµ‹åˆ°äº†æ–¹å‘ï¼ˆè€Œä¸æ˜¯çŒœæµ‹çš„ï¼‰
                    
                    if (previousPrevSongId !== 0 && info.id === previousPrevSongId) {
                        direction = 'prev'; // åˆ‡åˆ°äº†ä¸Šä¸€é¦–
                        isDirectionDetected = true;
                        console.log('[Frontend] âœ… æ£€æµ‹åˆ°åˆ‡æ¢åˆ°ä¸Šä¸€é¦– - ä½¿ç”¨ä»å·¦åˆ°å³æ‰«æï¼Œä»å·¦ä¸‹é£å…¥');
                    } else if (previousNextSongId !== 0 && info.id === previousNextSongId) {
                        direction = 'next'; // åˆ‡åˆ°äº†ä¸‹ä¸€é¦–
                        isDirectionDetected = true;
                        console.log('[Frontend] âœ… æ£€æµ‹åˆ°åˆ‡æ¢åˆ°ä¸‹ä¸€é¦– - ä½¿ç”¨ä»å³åˆ°å·¦æ‰«æï¼Œä»å³ä¸‹é£å…¥');
                    } else {
                        console.log('[Frontend] âš ï¸ æ— æ³•ç¡®å®šæ–¹å‘ï¼ˆé¦–æ¬¡æ’­æ”¾æˆ–éšæœºæ’­æ”¾ï¼‰ï¼Œä½¿ç”¨é»˜è®¤ï¼ˆä¸‹ä¸€é¦–ï¼‰');
                        isDirectionDetected = false;
                    }
                    
                    // éšè—æ‰€æœ‰å…ƒç´ 
                    elTitle.classList.remove('show');
                    elArtist.classList.remove('show');
                    elProgressContainer.classList.remove('show');
                    elSubControls.classList.remove('show');
                    elLyricsBox.classList.remove('show');

                    // å»¶è¿Ÿåæ›´æ–°æ–‡å­—å’Œæ˜¾ç¤º
                    setTimeout(() => {
                        elTitle.innerText = info.name || "æœªçŸ¥æ­Œæ›²";
                        elArtist.innerText = info.artist || "æœªçŸ¥æ­Œæ‰‹";
                        
                        // æ˜¾ç¤ºæ–‡å­—
                        setTimeout(() => {
                            elTitle.classList.add('show');
                            elArtist.classList.add('show');
                            elProgressContainer.classList.add('show');
                            elSubControls.classList.add('show');
                        }, 500);
                    }, 300);

                    let coverUrl = info.cover_url || DEFAULT_COVER;
                    
                    // ã€ä¼˜åŒ–ã€‘åªæœ‰åœ¨ç¡®å®æ£€æµ‹åˆ°äº†æ–¹å‘æ—¶ï¼Œæ‰ä»å·²åŠ è½½çš„å°å°é¢å¤ç”¨URL
                    // å¦‚æœæ–¹å‘æ— æ³•ç¡®å®šï¼ˆæ‰‹åŠ¨åˆ‡æ­Œ/éšæœºæ’­æ”¾ï¼‰ï¼Œåˆ™ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„URLä»¥ç¡®ä¿æ­£ç¡®
                    if (isDirectionDetected) {
                        try {
                            if (direction === 'prev') {
                                // æ³¨æ„ï¼šquerySelectorAllè¿”å›çš„NodeListéœ€è¦è½¬æ¢ä¸ºæ•°ç»„æ‰èƒ½ä½¿ç”¨find
                                const img = Array.from(elPrevImgs).find(e => e.classList.contains('active'));
                                if (img && img.src) {
                                    coverUrl = img.src;
                                    console.log('[Frontend] ğŸ“· ä»å·²åŠ è½½çš„å°å°é¢è·å–ä¸Šä¸€é¦–å›¾ç‰‡ - é¿å…é‡å¤åŠ è½½');
                                }
                            } else if (direction === 'next') {
                                // æ³¨æ„ï¼šquerySelectorAllè¿”å›çš„NodeListéœ€è¦è½¬æ¢ä¸ºæ•°ç»„æ‰èƒ½ä½¿ç”¨find
                                const img = Array.from(elNextImgs).find(e => e.classList.contains('active'));
                                if (img && img.src) {
                                    coverUrl = img.src;
                                    console.log('[Frontend] ğŸ“· ä»å·²åŠ è½½çš„å°å°é¢è·å–ä¸‹ä¸€é¦–å›¾ç‰‡ - é¿å…é‡å¤åŠ è½½');
                                }
                            }
                        } catch (e) {
                            console.warn('[Frontend] è·å–å°å°é¢å¤±è´¥ï¼Œä½¿ç”¨æœåŠ¡å™¨URL', e);
                        }
                    } else {
                        console.log('[Frontend] ğŸ¯ æ–¹å‘æœªç¡®å®šï¼Œä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„URL: ' + coverUrl);
                    }
                    
                    // é‡è¦ï¼šå…ˆæ›´æ–°currentSongIdï¼Œå³ä½¿åç»­æ“ä½œå¤±è´¥ä¹Ÿä¸ä¼šæ— é™å¾ªç¯
                    currentSongId = info.id;
                    
                    // åˆ‡æ¢å°é¢å’ŒèƒŒæ™¯ï¼ˆå¸¦æ–¹å‘æ„ŸçŸ¥çš„åŠ¨ç”»ï¼‰- ä¸ç­‰å¾…å®Œæˆ
                    try {
                        switchCoverWithFly(coverUrl, direction);
                        switchBackgroundScanline(coverUrl, direction);
                    } catch (e) {
                        console.error('[Frontend] åŠ¨ç”»åˆ‡æ¢å¤±è´¥', e);
                    }

                    lyricsData = [];
                    lastActiveIndex = -1;
                    elLyricsBox.innerHTML = '<div class="lrc-line loading-shimmer" style="text-align:center; opacity:0.5;">æ­£åœ¨åŠ è½½æ­Œè¯...</div>';
                    
                    fetchLyrics();
                } else if (lyricsData.length === 0 && !isFetchingLyrics) {
                    fetchLyrics();
                }
            }

            // 3. æ›´æ–°é‚»å±…å°é¢å’Œé¢„åŠ è½½é‚»å±…å›¾ç‰‡ï¼ˆä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
            if (playback) {
                if (playback.prev_song && playback.prev_song.cover) {
                    updateSmallCover(elPrevImgs, playback.prev_song.cover);
                    // å¼‚æ­¥é¢„åŠ è½½ä¸Šä¸€é¦–çš„å¤§å°é¢åˆ°ç¼“å­˜ï¼Œä¸é˜»å¡UI
                    preloadImageToCache(playback.prev_song.cover);
                } else {
                    elPrevImgs.forEach(img => img.classList.remove('active'));
                }

                if (playback.next_song && playback.next_song.cover) {
                    updateSmallCover(elNextImgs, playback.next_song.cover);
                    // å¼‚æ­¥é¢„åŠ è½½ä¸‹ä¸€é¦–çš„å¤§å°é¢åˆ°ç¼“å­˜ï¼Œä¸é˜»å¡UI
                    preloadImageToCache(playback.next_song.cover);
                } else {
                    elNextImgs.forEach(img => img.classList.remove('active'));
                }
            }

            // 4. æ›´æ–°æ’­æ”¾çŠ¶æ€ï¼ˆç§»é™¤å‘¼å¸åŠ¨ç”»ï¼‰
            const activeEl = activeCoverLayer === 1 ? elCover1 : elCover2;
            if (data.playing) {
                activeEl.classList.add('playing');
            } else {
                activeEl.classList.remove('playing');
            }

            // 5. æ¯æ¬¡éƒ½æ›´æ–°ä¸Šä¸€é¦–å’Œä¸‹ä¸€é¦–çš„IDï¼Œç”¨äºä¸‹æ¬¡åˆ¤æ–­æ–¹å‘
            // è¿™å¿…é¡»åœ¨åˆ‡æ­Œæ£€æµ‹ä¹‹åæ›´æ–°ï¼Œç¡®ä¿ä¸‹æ¬¡èƒ½æ­£ç¡®åˆ¤æ–­
            // æ³¨æ„ï¼šéœ€è¦è½¬æ¢ä¸ºæ•°å­—ç±»å‹ï¼Œå› ä¸ºplaybackè¿”å›çš„æ˜¯å­—ç¬¦ä¸²
            if (playback && playback.prev_song && playback.prev_song.id) {
                const prevId = Number(playback.prev_song.id);
                if (previousPrevSongId !== prevId) {
                    console.log(`[Frontend] æ›´æ–°ä¸Šä¸€é¦–ID: ${previousPrevSongId} -> ${prevId}`);
                    previousPrevSongId = prevId;
                }
            }
            if (playback && playback.next_song && playback.next_song.id) {
                const nextId = Number(playback.next_song.id);
                if (previousNextSongId !== nextId) {
                    console.log(`[Frontend] æ›´æ–°ä¸‹ä¸€é¦–ID: ${previousNextSongId} -> ${nextId}`);
                    previousNextSongId = nextId;
                }
            }
        }

        // æ¸²æŸ“å¾ªç¯ (60FPS)
        function renderLoop() {
            let preciseTime = lastServerTime;
            if (isPlaying) {
                const elapsed = (Date.now() - lastLocalTick) / 1000;
                preciseTime += elapsed;
            }

            if (preciseTime < lastRenderedTime) {
                preciseTime = lastRenderedTime; 
            }
            lastRenderedTime = preciseTime;

            // 1. æ›´æ–°è¿›åº¦æ¡
            if (currentTotalDuration > 0) {
                const pct = Math.min(100, Math.max(0, (preciseTime / currentTotalDuration) * 100));
                elProgFill.style.width = `${pct}%`;
                elCurrTime.innerText = formatTime(preciseTime);
            }

            // 2. åŒæ­¥æ­Œè¯
            syncLyrics(preciseTime);
            
            // 3. æ›´æ–°é€å­—æ­Œè¯æ¸å˜
            updateWordGradients(preciseTime);

            requestAnimationFrame(renderLoop);
        }

        // SVG å›¾æ ‡åº“
        function getModeIcon(mode) {
            const commonStyle = 'viewBox="0 0 24 24"';
            if (mode === 'list' || mode === 'loop') return `<svg ${commonStyle}><path d="M17 17H7v-3l-4 4 4 4v-3h12v-6h-2v4zm0-12v3h-12v6h-2v-8h14zm-4 4l4-4-4-4v3h-12v6h2v-4h10z"/></svg>`;
            if (mode === 'single' || mode === 'singleloop') return `<svg ${commonStyle}><path d="M17 17H7v-3l-4 4 4 4v-3h12v-6h-2v4zm0-12v3h-12v6h-2v-8h14zm-4 4l4-4-4-4v3h-12v6h2v-4h10z"/><text x="10" y="16" font-size="8" fill="white" font-weight="bold">1</text></svg>`;
            if (mode === 'random' || mode === 'shuffle') return `<svg ${commonStyle}><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>`;
            return `<svg ${commonStyle}><path d="M3 15h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V9H3v2zm0-6v2h18V5H3z"/></svg>`;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // æ­Œè¯å¤„ç†å‡½æ•°
        async function fetchLyrics() {
            if (isFetchingLyrics) return;
            isFetchingLyrics = true;
            try {
                const response = await fetch(`${BASE_URL}/lyrics?t=${Date.now()}`);
                const data = await response.json();
                if (data.id !== currentSongId) return;
                if (data.hasLyric || data.hasYrc) {
                    const parsed = parseAndMergeAll(data);
                    renderLyrics(parsed);
                } else { 
                    renderLyrics([]); 
                }
            } catch (e) { 
                console.error(e); 
            } finally { 
                isFetchingLyrics = false; 
            }
        }

        function parseLrcLine(text) {
            if (!text) return {};
            const lines = text.split('\n');
            const result = {};
            // ä¿®æ”¹äº†è¿™é‡Œï¼šå°† (\d{2}) æ”¹ä¸º (\d+) ä»¥åŒ¹é… [0:00.123] è¿™ç§ä¸€ä½æ•°åˆ†é’Ÿçš„æƒ…å†µ
            const regex = /\[(\d+):(\d{2})(?:[\.:](\d+))?\](.*)/;
            
            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    let msVal = 0;
                    const msStr = match[3] || "0";
                    // æ¯«ç§’å¤„ç†é€»è¾‘ä¿æŒä¸å˜
                    if (msStr.length === 2) msVal = parseInt(msStr) / 100;
                    else if (msStr.length === 3) msVal = parseInt(msStr) / 1000;
                    else if (msStr.length > 3) msVal = parseInt(msStr) / Math.pow(10, msStr.length); // å¢åŠ å¯¹æ›´é•¿æ¯«ç§’æ•°çš„å…¼å®¹
                    
                    const content = match[4].trim();
                    // å³ä½¿å†…å®¹ä¸ºç©ºä¹Ÿå¯èƒ½éœ€è¦ä¿ç•™å ä½ï¼Œä½†åœ¨ä½ çš„æ¸²æŸ“é€»è¾‘é‡Œéç©ºæ£€æŸ¥æ˜¯OKçš„
                    if (content) {
                        const time = min * 60 + sec + msVal;
                        // æ³¨æ„ï¼šå¦‚æœåŒä¸€æ—¶é—´æˆ³æœ‰å¤šè¡Œï¼ˆå¦‚0ç§’å¤„çš„ä½œè¯ä½œæ›²ï¼‰ï¼Œå¯¹è±¡å±æ€§ä¼šè¢«è¦†ç›–ï¼Œåªä¿ç•™æœ€åä¸€è¡Œã€‚
                        // å¦‚æœæƒ³ä¿ç•™æ‰€æœ‰ï¼Œéœ€è¦é¢å¤–é€»è¾‘ï¼Œä½†é€šå¸¸æ­Œè¯æ˜¾ç¤ºæ²¡é—®é¢˜ã€‚
                        result[time.toFixed(3)] = content;
                    }
                }
            });
            return result;
        }

        function parseYrc(text) {
            if (!text) return [];
            const lines = text.split('\n');
            const result = [];
            const lineRegex = /^\[(\d+),(\d+)\](.*)/;
            const wordRegex = /\((\d+),(\d+),(\d+)\)([^\(]+)/g;
            lines.forEach(line => {
                const match = line.match(lineRegex);
                if (match) {
                    const startTime = parseInt(match[1]) / 1000;
                    const duration = parseInt(match[2]) / 1000;
                    const contentRaw = match[3];
                    const words = [];
                    let wordMatch;
                    let fullText = "";
                    while ((wordMatch = wordRegex.exec(contentRaw)) !== null) {
                        const wStart = parseInt(wordMatch[1]) / 1000;
                        const wDur = parseInt(wordMatch[2]) / 1000;
                        const wTxt = wordMatch[4];
                        fullText += wTxt;
                        words.push({
                            time: wStart,
                            duration: wDur,
                            text: wTxt
                        });
                    }
                    if (fullText) {
                        result.push({
                            time: startTime,
                            duration: duration,
                            text: fullText,
                            words: words,
                            isYrc: true
                        });
                    }
                }
            });
            return result;
        }

        function parseAndMergeAll(packet) {
            const lrcMap = parseLrcLine(packet.lrc);
            const transMap = parseLrcLine(packet.tlyric);
            const romaMap = parseLrcLine(packet.romalrc);
            const lrcTimeline = Object.keys(lrcMap).sort((a, b) => parseFloat(a) - parseFloat(b));
            const enrichedLrc = lrcTimeline.map(tStr => {
                const t = parseFloat(tStr);
                const text = lrcMap[tStr];
                const findInMap = (map) => {
                    for (const k in map) {
                        if (Math.abs(parseFloat(k) - t) < 0.2) return map[k];
                    }
                    return "";
                };
                return {
                    time: t,
                    text: text,
                    trans: findInMap(transMap),
                    roma: findInMap(romaMap),
                    normalizedText: text.replace(/[^\w\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g, '').toLowerCase()
                };
            });

            if (!packet.hasYrc || !packet.yrc) {
                return enrichedLrc.map(item => ({
                    ...item,
                    isYrc: false
                }));
            }

            const yrcLines = parseYrc(packet.yrc);
            return yrcLines.map(yLine => {
                const yTextNorm = yLine.text.replace(/[^\w\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g, '').toLowerCase();
                let match = null;
                if (yTextNorm.length > 0) {
                    match = enrichedLrc.find(l => {
                        if (!l.normalizedText) return false;
                        return l.normalizedText === yTextNorm ||
                            l.normalizedText.includes(yTextNorm) ||
                            yTextNorm.includes(l.normalizedText);
                    });
                }
                if (!match) {
                    match = enrichedLrc.find(l => Math.abs(l.time - yLine.time) < 1.5);
                }
                return {
                    ...yLine,
                    isYrc: true,
                    trans: match ? match.trans : "",
                    roma: match ? match.roma : ""
                };
            });
        }

        function renderLyrics(lyrics) {
            lyricsData = lyrics;
            elLyricsBox.innerHTML = "";
            lastActiveIndex = -1;

            if (!lyrics || lyrics.length === 0) {
                elLyricsBox.innerHTML = '<div class="lrc-line" style="text-align:center; opacity:0.5;">ğŸµ çº¯éŸ³ä¹ / æš‚æ— æ­Œè¯</div>';
                setTimeout(() => elLyricsBox.classList.add('show'), 100);
                return;
            }

            const fragment = document.createDocumentFragment();
            lyrics.forEach((line, index) => {
                const div = document.createElement('div');
                div.className = 'lrc-line';
                div.id = `line-${index}`;
                div.style.animationDelay = `${index * 0.03}s`;

                let html = ``;
                if (line.roma) html += `<span class="roma">${line.roma}</span>`;
                
                if (line.isYrc && line.words && line.words.length > 0) {
                    html += `<div class="yrc-line-content">`;
                    line.words.forEach((w) => {
                        html += `<span class="yrc-word-box"><span class="yrc-word-base">${w.text}</span><span class="yrc-word-mask" data-start="${w.time}" data-dur="${w.duration}" style="--word-pct: 0%">${w.text}</span></span>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="lrc-text">${line.text}</div>`;
                }
                
                if (line.trans) html += `<span class="trans">${line.trans}</span>`;
                div.innerHTML = html;
                fragment.appendChild(div);
            });
            
            elLyricsBox.appendChild(fragment);
            setTimeout(() => elLyricsBox.classList.add('show'), 100);
        }

        function syncLyrics(currentTime) {
            if (!lyricsData.length) return;
            let activeIndex = -1;
            for (let i = lyricsData.length - 1; i >= 0; i--) {
                if (currentTime >= lyricsData[i].time) {
                    activeIndex = i;
                    break;
                }
            }

            if (activeIndex !== lastActiveIndex) {
                const lines = elLyricsBox.children;
                if (lastActiveIndex >= 0 && lastActiveIndex < lines.length) {
                    const prevLine = lines[lastActiveIndex];
                    prevLine.classList.remove('active');
                    const masks = prevLine.querySelectorAll('.yrc-word-mask');
                    masks.forEach(w => {
                        w.style.setProperty('--word-pct', '0%');
                        w.style.opacity = '0';
                    });
                }

                if (activeIndex >= 0 && activeIndex < lines.length) {
                    const activeLine = lines[activeIndex];
                    activeLine.classList.add('active');
                    const offset = activeLine.offsetTop - (elViewport.clientHeight / 2) + (activeLine.clientHeight / 2);
                    elViewport.scrollTo({
                        top: offset,
                        behavior: 'smooth'
                    });
                    const masks = activeLine.querySelectorAll('.yrc-word-mask');
                    masks.forEach(w => {
                        w.style.setProperty('--word-pct', '0%');
                        w.style.opacity = '0';
                    });
                }
                lastActiveIndex = activeIndex;
            }
        }

        function updateWordGradients(currentTime) {
            if (lastActiveIndex < 0 || lastActiveIndex >= lyricsData.length) return;
            const lineData = lyricsData[lastActiveIndex];
            if (!lineData.isYrc) return;
            const lineEl = document.getElementById(`line-${lastActiveIndex}`);
            if (!lineEl) return;
            const masks = lineEl.querySelectorAll('.yrc-word-mask');
            masks.forEach(w => {
                const start = parseFloat(w.dataset.start);
                const dur = parseFloat(w.dataset.dur);
                const end = start + dur;
                let pct = 0;
                if (currentTime < start) {
                    pct = 0;
                } else if (currentTime >= end) {
                    pct = 100;
                } else {
                    pct = ((currentTime - start) / dur) * 100;
                }
                if (pct <= 0) {
                    w.style.opacity = '0';
                } else {
                    w.style.opacity = '1';
                }
                w.style.setProperty('--word-pct', `${pct.toFixed(2)}%`);
            });
        }

        // å¯åŠ¨
        setInterval(fetchState, 500);
        fetchState();
        requestAnimationFrame(renderLoop);

        // åˆå§‹æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            elTitle.classList.add('show');
            elArtist.classList.add('show');
            elProgressContainer.classList.add('show');
            elSubControls.classList.add('show');
        }, 500);
    </script>
</body>
</html>