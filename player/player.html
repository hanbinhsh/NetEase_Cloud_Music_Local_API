<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer" />
    <title>Netease Music Player</title>
    <style>
        :root {
            --active-color: #ffffff;
            /* åº•å±‚æ–‡å­—é¢œè‰²ï¼šç¨æš—çš„ç°è‰²ï¼Œä¿è¯æœªæ’­æ”¾æ—¶æ¸…æ™° */
            --inactive-color: rgba(255, 255, 255, 0.45); 
            --blur-intensity: 60px;
            /* ç¾½åŒ–è¾¹ç¼˜å®½åº¦ï¼šè°ƒæ•´è¿™ä¸ªå€¼æ”¹å˜è¾¹ç¼˜æ¨¡ç³Šç¨‹åº¦ (åƒç´ ) */
            --gradient-feather: 20px; 
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #000;
        }

        #bg-layer {
            position: fixed;
            top: -100px; left: -100px; right: -100px; bottom: -100px;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            filter: blur(var(--blur-intensity)) brightness(0.5);
            z-index: 1;
            transition: background-image 0.8s ease-in-out;
        }

        .container {
            position: relative;
            z-index: 2;
            display: flex;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 40px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }

        .info-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 450px;
        }

        .album-art {
            width: 350px;
            height: 350px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            object-fit: cover;
            margin-bottom: 30px;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            background-color: rgba(255,255,255,0.1);
        }
        
        .album-art.playing {
            transform: scale(1.05);
            box-shadow: 0 30px 60px rgba(0,0,0,0.6);
        }

        .song-title {
            font-size: 32px;
            font-weight: 800;
            margin: 0 0 10px 0;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            line-height: 1.2;
        }

        .artist-name {
            font-size: 20px;
            color: rgba(255,255,255,0.9);
            margin: 0;
            font-weight: 500;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .lyrics-section {
            flex: 1.5;
            height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            scrollbar-width: none;
        }
        .lyrics-section::-webkit-scrollbar { display: none; }

        .lyrics-container {
            padding: 50vh 0;
            width: 100%;
        }

        .lrc-line {
            padding: 12px 20px;
            margin-left: 20px;
            border-radius: 8px;
            text-align: left;
            cursor: default;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(0.95);
            transform-origin: left center;
        }

        /* === åŒå±‚é€å­—æ­Œè¯æ ¸å¿ƒæ ·å¼ (ä¼˜åŒ–ç‰ˆ) === */
        
        /* å®¹å™¨ï¼šå»æ‰ä»»ä½•é¢å¤–çš„ margin */
        .yrc-word-box {
            display: inline-block;
            position: relative;
            /* margin-right: 1px;  <-- å·²åˆ é™¤ï¼Œæ¢å¤åŸå§‹å­—é—´è· */
        }

        /* åº•å±‚ï¼šåŸæœ¬çš„ç°è‰²å­— (æ°¸è¿œå®Œæ•´æ˜¾ç¤º) */
        .yrc-word-base {
            color: var(--inactive-color);
            white-space: pre-wrap;
        }

        /* é¡¶å±‚ï¼šç™½è‰²çš„é«˜äº®å­— (é€šè¿‡é®ç½©æ˜¾ç¤º) */
        .yrc-word-mask {
            position: absolute;
            top: 0; left: 0;
            color: var(--active-color);
            white-space: pre-wrap;
            width: 100%;
            
            /* é»˜è®¤é€æ˜åº¦ä¸º 0ï¼Œé˜²æ­¢ 0% æ—¶ç¾½åŒ–è¾¹ç¼˜æ¼å‡ºç™½è‰² */
            opacity: 0; 
            
            /* é®ç½©é€»è¾‘ï¼šå®å¿ƒ -> ç¾½åŒ–æ¸å˜ -> é€æ˜ */
            --gradient-stop: var(--word-pct);
            --gradient-end: calc(var(--word-pct) + var(--gradient-feather));
            
            -webkit-mask-image: linear-gradient(to right, 
                black 0%, 
                black var(--gradient-stop), 
                transparent var(--gradient-end)
            );
            mask-image: linear-gradient(to right, 
                black 0%, 
                black var(--gradient-stop), 
                transparent var(--gradient-end)
            );
            
            /* å¹³æ»‘è¿‡æ¸¡ */
            /* transition: opacity 0.1s linear; */
            will-change: mask-image, opacity;
            pointer-events: none;
        }

        /* æ™®é€šLRCæ•´è¡Œ */
        .lrc-text {
            font-size: 26px;
            font-weight: 700;
            color: var(--inactive-color);
            line-height: 1.4;
            transition: color 0.4s;
        }

        .lrc-line .trans {
            display: block;
            font-size: 18px;
            font-weight: 400;
            margin-top: 6px;
            opacity: 0.7;
            color: var(--inactive-color);
            transition: color 0.4s;
        }

        .lrc-line .roma {
            display: block;
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 4px;
            opacity: 0.6;
            color: var(--inactive-color);
            font-style: italic;
            transition: color 0.4s;
        }

        /* === æ¿€æ´»è¡Œæ•´ä½“çŠ¶æ€ === */
        .lrc-line.active {
            transform: scale(1);
        }

        /* æ™®é€šæ­Œè¯æ¿€æ´» */
        .lrc-line.active .lrc-text {
            color: var(--active-color);
            font-size: 32px;
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        .lrc-line.active .trans { color: rgba(255,255,255,0.9); opacity: 1; }
        .lrc-line.active .roma { color: rgba(255,255,255,0.8); opacity: 1; }

        .yrc-line-content {
            font-size: 28px;
            font-weight: 700;
            line-height: 1.4;
        }
        .lrc-line.active .yrc-line-content {
            font-size: 34px; 
        }

        @media (max-width: 768px) {
            .container { flex-direction: column; padding: 20px; }
            .info-section { flex: 0 0 auto; margin-bottom: 20px; width: 100%; }
            .album-art { width: 220px; height: 220px; margin-bottom: 15px; }
            .song-title { font-size: 24px; }
            .lyrics-section { width: 100%; height: 50vh; }
            .lrc-line { text-align: center; margin-left: 0; transform-origin: center center; }
            .yrc-line-content { font-size: 22px; }
            .lrc-line.active .yrc-line-content { font-size: 26px; }
        }
    </style>
</head>
<body>

    <div id="bg-layer"></div>

    <div class="container">
        <div class="info-section">
            <img src="" alt="Album Art" class="album-art" id="cover-img">
            <div style="margin-top: 20px;">
                <h1 class="song-title" id="title">Waiting...</h1>
                <h2 class="artist-name" id="artist">è¯·æ’­æ”¾ç½‘æ˜“äº‘éŸ³ä¹</h2>
            </div>
        </div>

        <div class="lyrics-section" id="lyrics-viewport">
            <div class="lyrics-container" id="lyrics-box"></div>
        </div>
    </div>

    <script>
        const BASE_URL = "http://192.168.31.22:18726";
        const DEFAULT_COVER = "https://p2.music.126.net/tGHU62DTbzHOs014gv0zkA==/18806046882229308.jpg";

        const elBg = document.getElementById('bg-layer');
        const elCover = document.getElementById('cover-img');
        const elTitle = document.getElementById('title');
        const elArtist = document.getElementById('artist');
        const elLyricsBox = document.getElementById('lyrics-box');
        const elViewport = document.getElementById('lyrics-viewport');

        let currentSongId = 0;
        let lyricsData = []; 
        let lastActiveIndex = -1;
        let isFetchingLyrics = false;

        let lastServerTime = 0; 
        let lastLocalTick = 0;  
        let isPlaying = false;  
        let lastRenderedTime = 0; 

        elCover.src = DEFAULT_COVER;
        elBg.style.backgroundImage = `url("${DEFAULT_COVER}")`;

        async function fetchState() {
            try {
                const response = await fetch(`${BASE_URL}/info?t=${Date.now()}`);
                const data = await response.json();
                if(data && data.basic_info) {
                    updatePlaybackUI(data);
                }
            } catch (e) {}
        }

        function updatePlaybackUI(data) {
            const info = data.basic_info;
            const playback = data.playback;

            if (playback && playback.current_sec !== undefined) {
                if (!data.playing) {
                    lastRenderedTime = playback.current_sec;
                }
                
                if (Math.abs(playback.current_sec - lastRenderedTime) > 0.5) {
                    lastRenderedTime = playback.current_sec; 
                }

                lastServerTime = playback.current_sec;
                lastLocalTick = Date.now();
                isPlaying = data.playing;
            }

            if (info.id !== 0) {
                if (info.id !== currentSongId) {
                    console.log(`[Frontend] åˆ‡æ­Œ: ${info.name}`);
                    elTitle.innerText = info.name || "æœªçŸ¥æ­Œæ›²";
                    elArtist.innerText = info.artist || "æœªçŸ¥æ­Œæ‰‹";
                    let coverUrl = info.cover_url || DEFAULT_COVER;
                    elCover.src = coverUrl;
                    elBg.style.backgroundImage = `url("${coverUrl}")`;

                    currentSongId = info.id;
                    lyricsData = [];
                    lastActiveIndex = -1;
                    elLyricsBox.innerHTML = '<div class="lrc-line" style="text-align:center; opacity:0.5;">æ­£åœ¨åŠ è½½æ­Œè¯...</div>';
                    
                    fetchLyrics();
                } else if (lyricsData.length === 0 && !isFetchingLyrics) {
                    fetchLyrics();
                }
            }

            if (data.playing) elCover.classList.add('playing');
            else elCover.classList.remove('playing');
        }

        async function fetchLyrics() {
            if (isFetchingLyrics) return;
            isFetchingLyrics = true;

            try {
                const response = await fetch(`${BASE_URL}/lyrics?t=${Date.now()}`);
                const data = await response.json();

                if (data.id !== currentSongId) return;

                if (data.hasLyric || data.hasYrc) {
                    const parsed = parseAndMergeAll(data);
                    renderLyrics(parsed);
                } else {
                    renderLyrics([]); 
                }
            } catch (e) {
                console.error(e);
            } finally {
                isFetchingLyrics = false;
            }
        }

        function parseLrcLine(text) {
            if (!text) return {};
            const lines = text.split('\n');
            const result = {}; 
            // å…¼å®¹ : å’Œ . åˆ†éš”æ¯«ç§’ï¼Œä»¥åŠ 2ä½æˆ–3ä½æ¯«ç§’
            const regex = /\[(\d{2}):(\d{2})(?:[\.:](\d+))?\](.*)/;

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    let msVal = 0;
                    const msStr = match[3] || "0";
                    if (msStr.length === 2) msVal = parseInt(msStr) / 100;
                    else if (msStr.length === 3) msVal = parseInt(msStr) / 1000;
                    
                    const content = match[4].trim();
                    if (content) {
                        const time = min * 60 + sec + msVal;
                        result[time.toFixed(3)] = content;
                    }
                }
            });
            return result;
        }

        function parseYrc(text) {
            if (!text) return [];
            const lines = text.split('\n');
            const result = [];
            const lineRegex = /^\[(\d+),(\d+)\](.*)/;
            const wordRegex = /\((\d+),(\d+),(\d+)\)([^\(]+)/g;

            lines.forEach(line => {
                const match = line.match(lineRegex);
                if (match) {
                    const startTime = parseInt(match[1]) / 1000; 
                    const duration = parseInt(match[2]) / 1000;
                    const contentRaw = match[3];
                    
                    const words = [];
                    let wordMatch;
                    let fullText = "";

                    while ((wordMatch = wordRegex.exec(contentRaw)) !== null) {
                        const wStart = parseInt(wordMatch[1]) / 1000;
                        const wDur = parseInt(wordMatch[2]) / 1000;
                        const wTxt = wordMatch[4];
                        fullText += wTxt;
                        words.push({
                            time: wStart,
                            duration: wDur,
                            text: wTxt
                        });
                    }

                    if (fullText) {
                        result.push({
                            time: startTime,
                            duration: duration,
                            text: fullText,
                            words: words, 
                            isYrc: true
                        });
                    }
                }
            });
            return result;
        }

        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ™ºèƒ½åˆå¹¶é€»è¾‘ï¼šæ–‡æœ¬åŒ¹é…ä¼˜å…ˆï¼Œæ—¶é—´åŒ¹é…å…œåº•
        function parseAndMergeAll(packet) {
            const lrcMap = parseLrcLine(packet.lrc);
            const transMap = parseLrcLine(packet.tlyric);
            const romaMap = parseLrcLine(packet.romalrc);

            // 1. æ„å»ºæ ‡å‡† LRC åˆ—è¡¨ï¼ˆåŒ…å«ç¿»è¯‘å’Œç½—é©¬éŸ³ï¼‰ä½œä¸ºâ€œèµ„æ–™åº“â€
            // LRC/Trans/Roma æ¥æºäºåŒä¸€å¥—å…ƒæ•°æ®ï¼Œæ—¶é—´è½´é€šå¸¸å®Œå…¨ä¸€è‡´ï¼Œæ‰€ä»¥è¿™é‡Œç”¨å°å®¹å·®åˆå¹¶
            const lrcTimeline = Object.keys(lrcMap).sort((a, b) => parseFloat(a) - parseFloat(b));
            const enrichedLrc = lrcTimeline.map(tStr => {
                const t = parseFloat(tStr);
                const text = lrcMap[tStr];
                
                const findInMap = (map) => {
                    // ç²¾ç¡®æŸ¥æ‰¾æˆ–æå°è¯¯å·®æŸ¥æ‰¾
                    for (const k in map) {
                        if (Math.abs(parseFloat(k) - t) < 0.2) return map[k];
                    }
                    return "";
                };

                return {
                    time: t,
                    text: text,
                    trans: findInMap(transMap),
                    roma: findInMap(romaMap),
                    // ç”Ÿæˆå½’ä¸€åŒ–æ–‡æœ¬ï¼ˆå»æ ‡ç‚¹ã€ç©ºæ ¼ã€è½¬å°å†™ï¼‰ï¼Œç”¨äºåç»­æ¯”å¯¹
                    // ä¾‹å¦‚ "å¤©å›½, ãã‚Œã¨ã‚‚åœ°ç„" -> "å¤©å›½ãã‚Œã¨ã‚‚åœ°ç„"
                    normalizedText: text.replace(/[^\w\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g, '').toLowerCase()
                };
            });

            // 2. å¦‚æœæ²¡æœ‰ YRCï¼Œç›´æ¥ä½¿ç”¨æ ‡å‡† LRC åˆ—è¡¨
            if (!packet.hasYrc || !packet.yrc) {
                return enrichedLrc.map(item => ({ ...item, isYrc: false }));
            }

            // 3. å¦‚æœæœ‰ YRCï¼Œä»¥ YRC ä¸ºä¸»è½´ï¼Œå°è¯•ä» enrichedLrc ä¸­â€œå¸å–â€ç¿»è¯‘å’Œç½—é©¬éŸ³
            const yrcLines = parseYrc(packet.yrc);
            
            return yrcLines.map(yLine => {
                const yTextNorm = yLine.text.replace(/[^\w\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff\uff66-\uff9f]/g, '').toLowerCase();
                
                // ç­–ç•¥ A: æ–‡æœ¬ç›¸ä¼¼åº¦åŒ¹é… (ä¼˜å…ˆ)
                // è§£å†³ YRC å’Œ LRC æ—¶é—´è½´å¯¹ä¸é½çš„é—®é¢˜
                let match = null;
                if (yTextNorm.length > 0) {
                    match = enrichedLrc.find(l => {
                        if (!l.normalizedText) return false;
                        // ç²¾ç¡®ç›¸ç­‰ æˆ– åŒ…å«å…³ç³»
                        return l.normalizedText === yTextNorm || 
                               l.normalizedText.includes(yTextNorm) || 
                               yTextNorm.includes(l.normalizedText);
                    });
                }

                // ç­–ç•¥ B: æ—¶é—´åŒ¹é… (å…œåº•)
                // å¦‚æœæ–‡æœ¬æ²¡åŒ¹é…ä¸Šï¼ˆå¯èƒ½æ˜¯çº¯éŸ³ä¹æˆ–æ‹Ÿå£°è¯ï¼‰ï¼Œå°è¯•æ‰¾æ—¶é—´æœ€è¿‘çš„
                // æ”¾å®½é˜ˆå€¼åˆ° 1.5ç§’
                if (!match) {
                    match = enrichedLrc.find(l => Math.abs(l.time - yLine.time) < 1.5);
                }

                return {
                    ...yLine,
                    isYrc: true,
                    // å¦‚æœæ‰¾åˆ°äº†åŒ¹é…å¯¹è±¡ï¼ŒæŠŠç¿»è¯‘å’Œç½—é©¬éŸ³æ‹¿è¿‡æ¥
                    trans: match ? match.trans : "",
                    roma: match ? match.roma : ""
                };
            });
        }

        function renderLyrics(lyrics) {
            lyricsData = lyrics;
            elLyricsBox.innerHTML = "";
            lastActiveIndex = -1;

            if (!lyrics || lyrics.length === 0) {
                elLyricsBox.innerHTML = '<div class="lrc-line" style="text-align:center; opacity:0.5;">ğŸµ çº¯éŸ³ä¹ / æš‚æ— æ­Œè¯</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            
            lyrics.forEach((line, index) => {
                const div = document.createElement('div');
                div.className = 'lrc-line';
                div.id = `line-${index}`; 

                let html = ``;
                if (line.roma) html += `<span class="roma">${line.roma}</span>`;

                if (line.isYrc && line.words && line.words.length > 0) {
                    html += `<div class="yrc-line-content">`;
                    line.words.forEach((w) => {
                        html += `<span class="yrc-word-box"><span class="yrc-word-base">${w.text}</span><span class="yrc-word-mask" data-start="${w.time}" data-dur="${w.duration}" style="--word-pct: 0%">${w.text}</span></span>`;
                    });
                    html += `</div>`;
                } else {
                    html += `<div class="lrc-text">${line.text}</div>`;
                }

                if (line.trans) html += `<span class="trans">${line.trans}</span>`;
                div.innerHTML = html;
                fragment.appendChild(div);
            });
            elLyricsBox.appendChild(fragment);
        }

        function renderLoop() {
            let preciseTime = lastServerTime;
            if (isPlaying) {
                const elapsed = (Date.now() - lastLocalTick) / 1000;
                preciseTime += elapsed;
            }

            if (preciseTime < lastRenderedTime) {
                preciseTime = lastRenderedTime; 
            }

            lastRenderedTime = preciseTime;

            syncLyrics(preciseTime);
            updateWordGradients(preciseTime);

            requestAnimationFrame(renderLoop);
        }

        function syncLyrics(currentTime) {
            if (!lyricsData.length) return;

            let activeIndex = -1;
            for (let i = lyricsData.length - 1; i >= 0; i--) {
                if (currentTime >= lyricsData[i].time) {
                    activeIndex = i;
                    break;
                }
            }

            if (activeIndex !== lastActiveIndex) {
                const lines = elLyricsBox.children;
                
                if (lastActiveIndex >= 0 && lastActiveIndex < lines.length) {
                    const prevLine = lines[lastActiveIndex];
                    prevLine.classList.remove('active');
                    const masks = prevLine.querySelectorAll('.yrc-word-mask');
                    masks.forEach(w => {
                        w.style.setProperty('--word-pct', '0%');
                        w.style.opacity = '0';
                    });
                }

                if (activeIndex >= 0 && activeIndex < lines.length) {
                    const activeLine = lines[activeIndex];
                    activeLine.classList.add('active');
                    
                    const offset = activeLine.offsetTop - (elViewport.clientHeight / 2) + (activeLine.clientHeight / 2);
                    elViewport.scrollTo({ top: offset, behavior: 'smooth' });
                    
                    const masks = activeLine.querySelectorAll('.yrc-word-mask');
                    masks.forEach(w => {
                        w.style.setProperty('--word-pct', '0%');
                        w.style.opacity = '0'; 
                    });
                }
                
                lastActiveIndex = activeIndex;
            }
        }

        function updateWordGradients(currentTime) {
            if (lastActiveIndex < 0 || lastActiveIndex >= lyricsData.length) return;
            
            const lineData = lyricsData[lastActiveIndex];
            if (!lineData.isYrc) return; 

            const lineEl = document.getElementById(`line-${lastActiveIndex}`);
            if (!lineEl) return;

            const masks = lineEl.querySelectorAll('.yrc-word-mask');
            
            masks.forEach(w => {
                const start = parseFloat(w.dataset.start);
                const dur = parseFloat(w.dataset.dur);
                const end = start + dur;

                let pct = 0;
                if (currentTime < start) {
                    pct = 0;
                } else if (currentTime >= end) {
                    pct = 100;
                } else {
                    pct = ((currentTime - start) / dur) * 100;
                }
                
                if (pct <= 0) {
                    w.style.opacity = '0';
                } else {
                    w.style.opacity = '1';
                }
                
                w.style.setProperty('--word-pct', `${pct.toFixed(2)}%`);
            });
        }

        setInterval(fetchState, 200); 
        fetchState();
        requestAnimationFrame(renderLoop); 
    </script>
</body>
</html>