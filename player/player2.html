<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL_MUSIC_PLAYER_V2.0</title>
    <!-- 引入科技感字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff0055;
            --neon-yellow: #f3ea59;
            --bg-dark: #050510;
            --glass-bg: rgba(10, 15, 30, 0.6);
            --scanline-color: rgba(0, 243, 255, 0.03);
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: var(--bg-dark);
            font-family: 'Share Tech Mono', monospace;
            color: #fff;
        }

        /* === 全局背景与扫描线特效 === */
        #bg-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(80px) brightness(0.4);
            z-index: 0;
            transition: background-image 1s ease;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, var(--scanline-color) 50%, transparent 50%);
            background-size: 100% 4px;
            z-index: 100; /* 最顶层遮罩 */
            pointer-events: none;
        }

        .vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, #000 100%);
            z-index: 1;
            pointer-events: none;
        }

        /* === 主容器 === */
        .container {
            position: relative;
            z-index: 2;
            display: flex;
            height: 100vh;
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            padding: 4vh 4vw;
            box-sizing: border-box;
            gap: 60px;
            align-items: center;
        }

        /* === 左侧：信息面板 HUD === */
        .info-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 80vh;
            position: relative;
            border-right: 1px solid rgba(0, 243, 255, 0.3);
            padding-right: 40px;
        }

        /* 装饰性角标 */
        .corner-decor {
            position: absolute;
            width: 20px; height: 20px;
            border: 2px solid var(--neon-cyan);
            transition: all 0.3s;
        }
        .top-left { top: -10px; left: -10px; border-bottom: none; border-right: none; }
        .bottom-right { bottom: -10px; right: 30px; border-top: none; border-left: none; border-color: var(--neon-pink); }

        /* 封面区域 */
        .cover-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            max-width: 400px;
            margin: 0 auto 40px auto;
        }

        .album-art {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* 赛博朋克切角 */
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
            border: 2px solid rgba(255, 255, 255, 0.1);
            filter: drop-shadow(0 0 15px rgba(0, 243, 255, 0.3));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .album-art.playing {
            transform: scale(1.02);
            filter: drop-shadow(0 0 25px rgba(0, 243, 255, 0.6));
        }

        /* 文本信息 */
        .text-info {
            text-align: left;
            position: relative;
        }

        .song-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            margin: 0;
            color: #fff;
            text-shadow: 2px 2px 0px var(--neon-pink), -1px -1px 10px var(--neon-cyan);
            line-height: 1.1;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .artist-name {
            font-size: 1.5rem;
            color: var(--neon-cyan);
            margin-top: 10px;
            letter-spacing: 1px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        /* 进度条 HUD */
        .progress-hud {
            margin-top: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            color: var(--neon-yellow);
        }

        .progress-bar-bg {
            flex-grow: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%);
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            box-shadow: 0 0 10px var(--neon-cyan);
            transition: width 0.25s linear;
        }

        /* === 右侧：歌词终端 === */
        .lyrics-panel {
            flex: 1.4;
            height: 80vh;
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            /* 科技切角边框 */
            clip-path: polygon(
                0 0, 
                100% 0, 
                100% 85%, 
                95% 100%, 
                0 100%
            );
        }

        .terminal-header {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 40px;
            background: rgba(0, 243, 255, 0.1);
            border-bottom: 1px solid rgba(0, 243, 255, 0.3);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 0.8rem;
            color: var(--neon-cyan);
            letter-spacing: 2px;
            z-index: 10;
        }

        .lyrics-viewport {
            height: 100%;
            overflow-y: hidden; /* JS控制滚动 */
            position: relative;
            mask-image: linear-gradient(to bottom, transparent 5%, black 20%, black 80%, transparent 95%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 5%, black 20%, black 80%, transparent 95%);
            padding-top: 40px; /* 避开header */
        }

        .lyrics-container {
            padding: 40vh 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* 赛博朋克风格通常左对齐更酷 */
        }

        .lrc-line {
            padding: 12px 30px;
            font-size: 1.4rem;
            color: rgba(255, 255, 255, 0.4);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: default;
            line-height: 1.4;
            text-align: left;
            width: 100%;
            box-sizing: border-box;
            border-left: 3px solid transparent;
        }

        .lrc-line .trans {
            display: block;
            font-size: 1rem;
            font-style: italic;
            margin-top: 4px;
            color: rgba(0, 243, 255, 0.5); /* 翻译用暗青色 */
        }

        .lrc-line.active {
            color: #fff;
            font-size: 1.6rem;
            background: linear-gradient(90deg, rgba(255, 0, 85, 0.15) 0%, transparent 100%);
            border-left: 3px solid var(--neon-pink);
            text-shadow: 0 0 10px rgba(255, 0, 85, 0.8);
            transform: translateX(10px);
        }

        .lrc-line.active .trans {
            color: var(--neon-cyan);
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.6);
        }

        /* === Glitch 动画 === */
        @keyframes glitch-anim {
            0% { transform: translate(0) }
            20% { transform: translate(-2px, 2px) }
            40% { transform: translate(-2px, -2px) }
            60% { transform: translate(2px, 2px) }
            80% { transform: translate(2px, -2px) }
            100% { transform: translate(0) }
        }
        .glitch-effect {
            animation: glitch-anim 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite;
            color: var(--neon-pink);
        }

        /* 响应式调整 (虽只需考虑电脑，但也防止窗口过小) */
        @media (max-width: 1024px) {
            .container { flex-direction: column; height: auto; overflow-y: auto; }
            .info-panel { height: auto; border-right: none; border-bottom: 1px solid var(--neon-cyan); padding-bottom: 20px; padding-right: 0;}
            .lyrics-panel { height: 60vh; width: 100%; margin-top: 20px; }
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div id="bg-layer"></div>

    <div class="container">
        <!-- 左侧信息区 -->
        <div class="info-panel">
            <div class="corner-decor top-left"></div>
            
            <div class="cover-wrapper">
                <img src="" alt="NO SIGNAL" class="album-art" id="cover-img">
            </div>
            
            <div class="text-info">
                <div style="font-size: 0.8rem; color: var(--neon-yellow); margin-bottom: 5px;">NOW PLAYING // SYSTEM_AUDIO</div>
                <h1 class="song-title" id="title">INITIALIZING...</h1>
                <h2 class="artist-name" id="artist">WAITING FOR DATA_STREAM</h2>
            </div>

            <div class="progress-hud">
                <span id="current-time">00:00</span>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <span id="total-time">00:00</span>
            </div>

            <div class="corner-decor bottom-right"></div>
        </div>

        <!-- 右侧歌词区 -->
        <div class="lyrics-panel">
            <div class="terminal-header">
                <span>>> LYRICS_MODULE_LOADED</span>
                <span style="margin-left: auto;">REC: ON</span>
            </div>
            <div class="lyrics-viewport" id="lyrics-viewport">
                <div class="lyrics-container" id="lyrics-box"></div>
            </div>
        </div>
    </div>

    <script>
        // 配置 API 地址
        const API_URL = "http://localhost:18726/info"; // 请修改为你自己的 API 地址
        // const API_URL = "http://192.168.31.22:18726/info"; 

        const DEFAULT_COVER = "https://p2.music.126.net/tGHU62DTbzHOs014gv0zkA==/18806046882229308.jpg";

        // DOM 元素
        const elBg = document.getElementById('bg-layer');
        const elCover = document.getElementById('cover-img');
        const elTitle = document.getElementById('title');
        const elArtist = document.getElementById('artist');
        const elLyricsBox = document.getElementById('lyrics-box');
        const elViewport = document.getElementById('lyrics-viewport');
        const elProgressFill = document.getElementById('progress-fill');
        const elCurrentTime = document.getElementById('current-time');
        const elTotalTime = document.getElementById('total-time');

        let currentSongId = 0;
        let lyricsData = [];
        let lastActiveIndex = -1;

        // 初始化默认状态
        elCover.src = DEFAULT_COVER;
        elBg.style.backgroundImage = `url("${DEFAULT_COVER}")`;

        async function fetchState() {
            try {
                // 添加时间戳防止缓存
                const response = await fetch(API_URL + "?t=" + Date.now());
                const data = await response.json();
                
                if(data && data.basic_info) {
                    updateUI(data);
                }
            } catch (e) {
                // 连接失败时不报错，静默等待重连
            }
        }

        function updateUI(data) {
            if (!data || !data.playback || !data.basic_info) return;

            const info = data.basic_info;
            const playback = data.playback;
            const lrc = data.lyrics;

            // 1. 处理切歌
            if (info.id !== 0 && info.id !== currentSongId) {
                
                // 触发 Glitch 特效
                triggerGlitch(elTitle);
                
                // 更新文本
                elTitle.innerText = info.name || "UNKNOWN_TRACK";
                elArtist.innerText = info.artist || "UNKNOWN_ARTIST";
                
                // 更新封面
                let coverUrl = info.cover_url || DEFAULT_COVER;
                elCover.src = coverUrl;
                elBg.style.backgroundImage = `url("${coverUrl}")`;

                // 更新歌词
                if (lrc && lrc.all_lyrics && lrc.all_lyrics.length > 0) {
                    renderLyrics(lrc.all_lyrics);
                } else {
                    lyricsData = [];
                    elLyricsBox.innerHTML = '<div class="lrc-line" style="text-align:center; opacity:0.5;">>> NO_LYRICS_FOUND_</div>';
                }
                
                currentSongId = info.id;
                lastActiveIndex = -1;
            } 
            
            // 2. 补漏逻辑 (防止切歌时歌词没加载出来)
            if (info.id === currentSongId && lyricsData.length === 0) {
                if (lrc && lrc.all_lyrics && lrc.all_lyrics.length > 0) {
                    renderLyrics(lrc.all_lyrics);
                }
            }

            // 3. 更新进度条和时间 (Cyberpunk HUD)
            if (playback) {
                // 使用百分比更新宽度
                elProgressFill.style.width = `${playback.percentage}%`;
                elCurrentTime.innerText = playback.formatted_current || "00:00";
                elTotalTime.innerText = playback.formatted_total || "00:00";
                
                // 同步歌词
                if (playback.current_sec !== undefined) {
                    syncLyrics(playback.current_sec);
                }
            }

            // 4. 播放状态动画
            if (data.playing) {
                elCover.classList.add('playing');
                elProgressFill.style.boxShadow = "0 0 15px var(--neon-cyan)";
            } else {
                elCover.classList.remove('playing');
                elProgressFill.style.boxShadow = "none";
            }
        }

        function renderLyrics(lyrics) {
            lyricsData = lyrics;
            elLyricsBox.innerHTML = "";
            lastActiveIndex = -1;

            if (!lyrics || lyrics.length === 0) return;

            const fragment = document.createDocumentFragment();
            lyrics.forEach((line) => {
                const div = document.createElement('div');
                div.className = 'lrc-line';
                div.dataset.time = line.time;
                
                let html = `<span>${line.text}</span>`;
                if (line.trans) {
                    html += `<span class="trans">// ${line.trans}</span>`;
                }
                div.innerHTML = html;
                fragment.appendChild(div);
            });
            elLyricsBox.appendChild(fragment);
        }

        function syncLyrics(currentTime) {
            if (!lyricsData.length) return;
            
            // 查找当前时间对应的那一行
            let activeIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) {
                    activeIndex = i;
                } else {
                    break; 
                }
            }

            // 如果行号变了，更新 DOM
            if (activeIndex !== lastActiveIndex) {
                const lines = elLyricsBox.children;
                
                // 移除旧高亮
                if (lastActiveIndex >= 0 && lastActiveIndex < lines.length) {
                    lines[lastActiveIndex].classList.remove('active');
                }
                
                // 添加新高亮并滚动
                if (activeIndex >= 0 && activeIndex < lines.length) {
                    const activeLine = lines[activeIndex];
                    activeLine.classList.add('active');
                    
                    // 计算滚动位置，使高亮行居中
                    const offset = activeLine.offsetTop - (elViewport.clientHeight / 2) + (activeLine.clientHeight / 2);
                    elViewport.scrollTo({ top: offset, behavior: 'smooth' });
                }
                lastActiveIndex = activeIndex;
            }
        }

        // 简单的文字 Glitch 效果触发器
        function triggerGlitch(element) {
            element.classList.add('glitch-effect');
            setTimeout(() => {
                element.classList.remove('glitch-effect');
            }, 600);
        }

        // 每200ms轮询一次状态
        setInterval(fetchState, 200);
        fetchState();
    </script>
</body>
</html>